# Модель данных B3 Learning Portal

**Версия:** 2.0
**Дата:** 2025-12-10
**Статус:** Updated

---

## 1. Обзор модели данных

Модель данных B3 Learning Portal построена на принципе **Template → Instance** (Шаблон → Экземпляр), где:
- **Шаблоны** определяют структуру и содержание курсов (создаются методистами)
- **Экземпляры** создаются для каждой учебной группы и каждого слушателя

Это обеспечивает:
- Переиспользование контента (один шаблон → много учебных групп)
- Изоляцию данных (работа студента не влияет на других)
- Гибкость (каждая группа может настраиваться индивидуально)

### Ключевые принципы

1. **Separation of Concerns**: Четкое разделение на пользователей, контент, процессы обучения
2. **Traceability**: Каждый экземпляр связан со своим шаблоном через внешний ключ
3. **Status-Driven Workflows**: Все сущности имеют явные статусы для управления BPMN-процессами
4. **Audit Trail**: Временные метки и связи для отслеживания всех действий

---

## 2. ER-диаграмма (текстовое описание связей)

```
ПОЛЬЗОВАТЕЛИ:
┌──────────────────┐
│   Пользователь   │ (базовая сущность B3)
└────────┬─────────┘
         │
         ├──────────────────────────────────┐
         │                                  │
         ▼                                  ▼
┌──────────────────┐              ┌──────────────────┐
│ Слушатель курса  │              │ Преподаватель /  │
│                  │              │    Методист      │
└────────┬─────────┘              └──────────────────┘
         │
         │ записан на ▼
         │
         │      ┌─────────────────────┐
         └─────►│  Запись на курс     │◄──┐
                │   (Enrollment)      │   │
                └──────────┬──────────┘   │
                           │              │ ссылается на
                           │              │
                           ▼              │
                  ┌─────────────────────┐ │
                  │ Экземпляр курса     │─┘
                  │ (Course Instance)   │
                  │ Учебная группа      │
                  └──────────┬──────────┘
                             │
                             │ основан на ▼
                             │
                    ┌─────────────────────┐
                    │   Шаблон курса      │
                    │ (Course Template)   │
                    └──────────┬──────────┘
                               │
                               │ содержит ▼
                               │
                      ┌─────────────────────┐
                      │  Шаблон задания     │
                      │(Assignment Template)│
                      └──────────┬──────────┘
                                 │
                                 │ порождает ▼
                                 │
                        ┌─────────────────────┐
                        │ Экземпляр задания   │
                        │(Assignment Instance)│◄────┐
                        └──────────┬──────────┘     │
                                   │                │ связь с
                                   │                │
                                   ▼                │
                          ┌─────────────────────┐   │
                          │      Диалог         │───┘
                          │  (по заданию)       │
                          └──────────┬──────────┘
                                     │
                                     │ содержит ▼
                                     │
                            ┌─────────────────────┐
                            │     Сообщение       │
                            │     (Message)       │
                            └─────────────────────┘

ГРАФИКИ:
┌──────────────────────┐
│  График запуска      │
│ (Launch Schedule)    │
└──────────┬───────────┘
           │ для ▼
           │
  ┌─────────────────────────┐
  │   Шаблон курса          │
  └─────────────────────────┘

┌──────────────────────┐
│  График заданий      │
│(Assignment Schedule) │
└──────────┬───────────┘
           │ для ▼
           │
  ┌─────────────────────────┐
  │ Экземпляр курса         │
  │ + Шаблон задания        │
  └─────────────────────────┘

СЕРТИФИКАТЫ:
┌──────────────────────┐
│  Шаблон сертификата  │
│(Certificate Template)│
└──────────┬───────────┘
           │
           │ используется для ▼
           │
  ┌─────────────────────────┐
  │ Экземпляр сертификата   │
  │ (Certificate Instance)  │
  └─────────────────────────┘

УВЕДОМЛЕНИЯ:
┌──────────────────────┐
│    Уведомление       │
│   (Notification)     │
└──────────────────────┘
```

---

## 3. Детальное описание сущностей

### 3.1. Пользователи

#### 3.1.1. Пользователь (User)

**Описание:** Базовая сущность B3 для аутентификации и авторизации. Расширяется для специфичных ролей.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `username` | String(100) | Да | Логин пользователя |
| `email` | Email | Да | Email (уникальный) |
| `full_name` | String(255) | Да | ФИО |
| `phone` | String(20) | Нет | Телефон |
| `is_active` | Boolean | Да | Активен ли аккаунт |
| `created_at` | DateTime | Да | Дата создания |
| `last_login` | DateTime | Нет | Последний вход в систему |

**Связи:**
- Роли: многие-ко-многим (User ↔ Role)

**Примечания:**
- Используется стандартная модель пользователей B3
- Поддерживает SSO/LDAP интеграцию

---

#### 3.1.2. Слушатель курса (Student)

**Описание:** Расширение сущности "Пользователь" с метаданными для учебного процесса.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `user_id` | UUID (FK) | Да | Ссылка на Пользователь |
| `organization` | String(255) | Нет | Организация |
| `department` | String(255) | Нет | Подразделение |
| `position` | String(255) | Нет | Должность |
| `employee_id` | String(50) | Нет | Табельный номер |
| `learning_goals` | Text | Нет | Цели обучения |
| `bio` | Text | Нет | О себе |

**Связи:**
- Один-к-одному: Student → User
- Один-ко-многим: Student → Enrollment (записи на курсы)

---

#### 3.1.3. Преподаватель курса / Методист курса (Instructor/Author)

**Описание:** Роли пользователя для преподавания и создания контента.

**Реализация:**
- Определяется через системные роли B3 (`instructor`, `course_author`)
- Не требует отдельной сущности

**Права доступа:**
- **Методист**: создание/редактирование Шаблонов курсов и заданий
- **Преподаватель**: ведение Экземпляров курсов, проверка заданий, общение со студентами

---

### 3.2. Курсы

#### 3.2.1. Шаблон курса (Course Template)

**Описание:** Определение курса, создаваемое методистом. Является основой для запуска учебных групп.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `code` | String(50) | Да | Код курса (уникальный, например "B3-101") |
| `title` | String(255) | Да | Название курса |
| `description` | Text | Да | Полное описание |
| `short_description` | Text | Нет | Краткое описание (для карточек) |
| `level` | Enum | Да | Уровень: `basic` / `intermediate` / `advanced` |
| `category` | String(100) | Нет | Категория (например, "Администрирование", "Разработка") |
| `target_audience` | Text | Нет | Целевая аудитория |
| `prerequisites` | Text | Нет | Требуемые навыки / предварительные курсы |
| `duration_hours` | Integer | Нет | Продолжительность в часах |
| `certification_threshold` | Decimal(5,2) | Да | Минимальный балл для сертификации (0-100) |
| `requires_lab_environment` | Boolean | Да | Требуется ли стенд для практики |
| `cover_image` | File | Нет | Обложка курса |
| `accessibility` | Enum | Да | Доступность: `public` / `registered` |
| `status` | Enum | Да | Статус: `draft` / `published` / `archived` |
| `created_by` | UUID (FK) | Да | Автор (методист) |
| `certificate_template_id` | UUID (FK) | Нет | Шаблон сертификата для курса |
| `created_at` | DateTime | Да | Дата создания |
| `updated_at` | DateTime | Да | Последнее обновление |

**Связи:**
- Один-ко-многим: Course Template → Assignment Template (задания курса)
- Один-ко-многим: Course Template → Course Instance (экземпляры/учебные группы)
- Один-ко-многим: Course Template → Launch Schedule (графики запуска)
- Многие-к-одному: Course Template → User (автор)
- Многие-к-одному: Course Template → Certificate Template (шаблон сертификата)

**Бизнес-правила:**
- `code` должен быть уникальным в системе
- Видимость в каталоге определяется: `status = published` AND `accessibility`
- `certification_threshold` используется в BPMN-процессе выдачи сертификата
- Изменение шаблона **не влияет** на уже запущенные экземпляры

**Статусная модель:**
- `draft`: Черновик (начальное состояние). Курс не виден в каталоге.
- `published`: Опубликован. Курс виден в каталоге согласно настройке `accessibility`.
- `archived`: Архивирован. Курс скрыт из каталога, сохраняется для истории.

**Переходы статусов:**
- `draft → published`: Методист публикует курс
- `published → draft`: Методист снимает с публикации
- `published → archived`: Методист/Администратор архивирует
- `draft → archived`: Методист/Администратор архивирует черновик

---

#### 3.2.2. Экземпляр курса / Учебная группа (Course Instance)

**Описание:** Конкретная учебная группа с назначенным преподавателем и датами. Представляет запуск курса для определенной группы студентов.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `course_template_id` | UUID (FK) | Да | Ссылка на Шаблон курса |
| `group_name` | String(100) | Нет | Название учебной группы (например, "Группа октябрь 2025") |
| `instructor_id` | UUID (FK) | Да | Преподаватель |
| `start_date` | Date | Да | Дата начала |
| `end_date` | Date | Да | Дата окончания |
| `status` | Enum | Да | Статус: `planned` / `active` / `completed` / `archived` |
| `created_at` | DateTime | Да | Дата создания |

**Связи:**
- Многие-к-одному: Course Instance → Course Template
- Многие-к-одному: Course Instance → User (преподаватель)
- Один-ко-многим: Course Instance → Enrollment (записи слушателей)
- Один-ко-многим: Course Instance → вычисляемые даты заданий (на основе Assignment Schedule)

**Статусная модель:**
- `planned`: Запланирован. Группа создана, но обучение еще не началось.
- `active`: Активен. Идет обучение.
- `completed`: Завершен. Обучение окончено, все процессы завершены.
- `archived`: Архивирован. Группа скрыта из активных списков.

**Переходы статусов:**
- `planned → active`: Автоматически при наступлении `start_date` или вручную преподавателем
- `active → completed`: Автоматически при наступлении `end_date` или вручную
- `completed → archived`: Администратор архивирует группу

**Бизнес-правила:**
- При создании экземпляра система автоматически вычисляет даты заданий на основе Assignment Schedule
- Концептуально представляет "Учебную группу" (не "Поток")

---

#### 3.2.3. Запись на курс (Enrollment)

**Описание:** Связь студента и экземпляра курса. Центральная сущность для отслеживания прогресса. Включает функциональность заявки на регистрацию через статусы `created` и `pending_approval`.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `student_id` | UUID (FK) | Да | Слушатель |
| `course_instance_id` | UUID (FK) | Да | Экземпляр курса |
| `status` | Enum | Да | `created` / `pending_approval` / `approved` / `rejected` / `active` / `completed` / `withdrawn` / `failed` |
| `enrolled_at` | DateTime | Да | Дата записи |
| `last_activity_at` | DateTime | Нет | Последняя активность |
| `completion_date` | DateTime | Нет | Дата завершения |
| `total_score` | Decimal(5,2) | Нет | Итоговый балл (0-100) |
| `progress_percentage` | Decimal(5,2) | Нет | Процент завершения (0-100) |
| `allocated_resources` | Text | Нет | Выделенные ресурсы (URL стенда, учетные данные и т.д.) |
| `request_comment` | Text | Нет | Комментарий при подаче заявки |
| `approval_comment` | Text | Нет | Комментарий администратора при согласовании |
| `approved_by` | UUID (FK) | Нет | Кто согласовал заявку |
| `approved_at` | DateTime | Нет | Когда согласована |

**Связи:**
- Многие-к-одному: Enrollment → Student
- Многие-к-одному: Enrollment → Course Instance
- Многие-к-одному: Enrollment → User (approved_by)
- Один-ко-многим: Enrollment → Assignment Instance (задания студента)
- Один-к-одному: Enrollment → Certificate Instance (если курс завершен)

**Статусная модель:**
- `created`: Создана. Студент добавил курс в свой список, но еще не отправил заявку на согласование.
- `pending_approval`: Ожидает согласования. Студент подал заявку на курс.
- `approved`: Согласована, ожидает старта. Администратор одобрил заявку.
- `rejected`: Отклонена. Администратор отклонил заявку с указанием причины.
- `active`: Активная запись. Студент проходит курс.
- `completed`: Курс пройден. Студент успешно завершил курс.
- `withdrawn`: Отчислен. Студент отчислен с курса.
- `failed`: Не пройден. Студент не выполнил требования курса.

**Переходы статусов:**
- `created → pending_approval`: Студент отправляет заявку на согласование
- `created → [удалена]`: Студент удаляет неотправленную заявку
- `pending_approval → approved`: Администратор одобряет заявку
- `pending_approval → rejected`: Администратор отклоняет заявку
- `rejected → created`: Студент редактирует и готовит к повторной отправке (из pending_approval)
- `approved → rejected`: Администратор отзывает согласование (до старта курса)
- `rejected → created`: Студент редактирует отклоненную заявку для повторной подачи (из approved)
- `approved → active`: Автоматически при старте курса (`course_instance.status = active`)
- `active → completed`: Автоматически при выполнении условий сертификации
- `active → withdrawn`: Администратор или студент отчисляет
- `active → failed`: Автоматически при наступлении `end_date` без выполнения условий

**Вычисляемые поля:**
- `progress_percentage` = (завершенных заданий) / (всего заданий) × 100
- `total_score` = средний балл по всем обязательным заданиям

**Бизнес-правила:**
- При создании Enrollment автоматически создаются Assignment Instance для всех заданий курса
- Переход в `completed` происходит при выполнении условий сертификации
- `allocated_resources` содержит текстовое описание выделенных ресурсов (стенд, креды и т.д.)

**Примечание:**
Статус `pending_approval` заменяет отдельную сущность "Enrollment Request". Все заявки на регистрацию обрабатываются через эту же сущность.

---

### 3.3. Задания

#### 3.3.1. Шаблон задания (Assignment Template)

**Описание:** Определение задания в рамках курса (создается методистом).

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `course_template_id` | UUID (FK) | Да | Курс, к которому относится |
| `module_number` | Integer | Да | Номер модуля |
| `order_number` | Integer | Да | Порядковый номер в курсе |
| `title` | String(255) | Да | Название задания |
| `description` | Text | Да | Описание задания |
| `type` | Enum | Да | `lecture` / `lab` / `quiz` / `project` / `peer_review` |
| `delivery_mode` | Enum | Да | `in_person` / `self_study` |
| `submission_type` | Array/JSON | Нет | Массив типов: `text`, `file`, `url`, `none` |
| `max_score` | Decimal(5,2) | Да | Максимальный балл |
| `is_mandatory` | Boolean | Да | Обязательное для сертификации |
| `materials` | JSON | Нет | Массив ссылок на файлы/URL (лекции, инструкции) |
| `grading_criteria` | Text | Нет | Критерии оценивания |
| `status` | Enum | Да | Статус: `draft` / `active` / `archived` |
| `created_at` | DateTime | Да | Дата создания |
| `updated_at` | DateTime | Да | Последнее обновление |

**Связи:**
- Многие-к-одному: Assignment Template → Course Template
- Один-ко-многим: Assignment Template → Assignment Instance
- Один-к-одному: Assignment Template → Assignment Schedule (график задания)

**Типы заданий:**
- `lecture`: Информационный материал (автозасчитывается при просмотре)
- `lab`: Лабораторная работа (требует проверки преподавателем)
- `quiz`: Тест (может автопроверяться)
- `project`: Проектная работа
- `peer_review`: Взаимная проверка студентами

**Статусная модель:**
- `draft`: Черновик. Задание в разработке.
- `active`: Активен. Задание используется в курсе.
- `archived`: Архивирован. Задание более не используется.

**Переходы статусов:**
- `draft → active`: Методист публикует курс (или активирует задание)
- `active → archived`: Методист при удалении из курса или архивировании

**Бизнес-правила:**
- `order_number` определяет последовательность заданий
- `submission_type` - массив, так как задание может принимать несколько типов сдачи
- Изменение шаблона не влияет на уже созданные экземпляры

---

#### 3.3.2. Экземпляр задания (Assignment Instance)

**Описание:** Задание, назначенное конкретному студенту в рамках его записи на курс.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `assignment_template_id` | UUID (FK) | Да | Шаблон задания |
| `enrollment_id` | UUID (FK) | Да | Запись на курс (связь со студентом) |
| `status` | Enum | Да | `not_started` / `in_progress` / `under_review` / `completed` / `needs_revision` |
| `submission_text` | Text | Нет | Текстовое решение |
| `submission_files` | JSON | Нет | Массив загруженных файлов |
| `submission_url` | String(255) | Нет | Ссылка на решение |
| `submitted_at` | DateTime | Нет | Дата сдачи |
| `grade` | Decimal(5,2) | Нет | Оценка (0 до max_score) |
| `feedback` | Text | Нет | Комментарий преподавателя |
| `graded_at` | DateTime | Нет | Дата проверки |
| `graded_by` | UUID (FK) | Нет | Преподаватель, проверивший работу |
| `attempt_count` | Integer | Да | Количество попыток сдачи (default: 0) |

**Связи:**
- Многие-к-одному: Assignment Instance → Assignment Template
- Многие-к-одному: Assignment Instance → Enrollment
- Многие-к-одному: Assignment Instance → User (преподаватель, проверивший)
- Один-ко-многим: Assignment Instance → Dialog (диалог по заданию)

**Статусная модель:**
- `not_started`: Не начато. Студент еще не открыл задание.
- `in_progress`: В работе. Студент работает над заданием.
- `under_review`: На проверке. Преподаватель проверяет работу.
- `completed`: Завершено. Работа проверена и оценена (или автозачёт для заданий без проверки).
- `needs_revision`: Требует доработки. Работа возвращена на доработку.

**Переходы статусов:**
- `not_started → in_progress`: Студент открыл задание
- `in_progress → under_review`: Студент нажал "Отправить на проверку"
- `in_progress → completed`: Автозачёт (для заданий типа `lecture` или с `autoGrade=true`, не требующих проверки)
- `under_review → completed`: Преподаватель оценил и принял работу
- `under_review → needs_revision`: Преподаватель вернул на доработку
- `needs_revision → in_progress`: Студент приступил к исправлениям (increment `attempt_count`)

**BPMN-процесс (сдача задания):**
1. Студент нажимает "Отправить" → `under_review`
2. Преподавателю создается задача на проверку
3. Преподаватель оценивает:
   - Принято → `completed` + оценка + уведомление студенту
   - Доработка → `needs_revision` + комментарий + уведомление

**BPMN-процесс (автозачёт для лекций):**
1. Студент открывает задание типа `lecture` → `in_progress`
2. Студент просматривает материал
3. При достижении условий (время просмотра / подтверждение) → `completed` + max_score

**Бизнес-правила:**
- Дедлайны определяются через Assignment Schedule (отдельная сущность)
- При `needs_revision` студент может повторно отправить (increment `attempt_count`)

**Примечание:**
Поле `due_date` удалено. Дедлайны вычисляются на основе Assignment Schedule при создании учебной группы.

---

### 3.4. Коммуникации

#### 3.4.1. Диалог (Dialog)

**Описание:** Контейнер для переписки между студентом и преподавателем (по курсу или конкретному заданию).

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `type` | Enum | Да | `course` / `assignment` |
| `reference_id` | UUID | Да | ID Enrollment (для курса) или Assignment Instance (для задания) |
| `participants` | JSON | Нет | Массив user_id участников (студент + преподаватели) |
| `status` | Enum | Да | `active` / `archived` |
| `created_at` | DateTime | Да | Дата создания |
| `last_message_at` | DateTime | Нет | Последнее сообщение |

**Связи:**
- Один-ко-многим: Dialog → Message (сообщения в диалоге)
- Полиморфная связь через `reference_id`:
  - Если `type=course` → `reference_id` = Enrollment.id
  - Если `type=assignment` → `reference_id` = Assignment Instance.id

**Статусная модель:**
- `active`: Активен. Диалог открыт для общения.
- `archived`: Архивирован. Диалог закрыт, но сохранен для истории.

**Переходы статусов:**
- `active → archived`: Преподаватель или администратор архивирует диалог после завершения курса

**Бизнес-правила:**
- Диалог создается автоматически при записи на курс (`type=course`)
- Диалог по заданию создается при первой необходимости (отправка вопроса/комментария)

---

#### 3.4.2. Сообщение (Message)

**Описание:** Отдельное сообщение в диалоге.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `dialog_id` | UUID (FK) | Да | Диалог |
| `author_id` | UUID (FK) | Да | Автор сообщения |
| `text` | Text | Да | Текст сообщения |
| `attachments` | JSON | Нет | Массив прикрепленных файлов |
| `is_read` | Boolean | Да | Прочитано ли (default: false) |
| `created_at` | DateTime | Да | Дата создания |

**Связи:**
- Многие-к-одному: Message → Dialog
- Многие-к-одному: Message → User (автор)

**Бизнес-правила:**
- При создании нового сообщения создается Notification для непрочитавших участников
- Автоматическая установка `is_read=true` при открытии диалога

**Примечание:**
Для сообщений не требуется отдельный статус, достаточно флага `is_read`.

---

### 3.5. Сертификаты

#### 3.5.1. Шаблон сертификата (Certificate Template)

**Описание:** Макет сертификата для печатной формы B3.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `name` | String(255) | Да | Название шаблона |
| `course_type` | Enum | Нет | Для какого типа курса: `basic` / `intermediate` / `advanced` / `all` |
| `print_form_id` | UUID (FK) | Да | Ссылка на печатную форму B3 |
| `description` | Text | Нет | Описание |
| `status` | Enum | Да | Статус: `draft` / `active` / `archived` |
| `created_at` | DateTime | Да | Дата создания |

**Связи:**
- Один-ко-многим: Certificate Template → Certificate Instance
- Один-к-одному: Certificate Template → B3 Print Form

**Статусная модель:**
- `draft`: Черновик. Шаблон в разработке.
- `active`: Активен. Шаблон используется для выдачи сертификатов.
- `archived`: Архивирован. Шаблон больше не используется.

**Переходы статусов:**
- `draft → active`: Администратор активирует шаблон
- `active → archived`: Администратор архивирует устаревший шаблон

**Бизнес-правила:**
- Шаблон содержит макет с плейсхолдерами: `{student_name}`, `{course_title}`, `{completion_date}`, `{certificate_number}`, `{score}`
- Генерация PDF выполняется конструктором печатных форм B3

---

#### 3.5.2. Экземпляр сертификата (Certificate Instance)

**Описание:** Выданный сертификат конкретному студенту.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `certificate_template_id` | UUID (FK) | Да | Шаблон сертификата |
| `enrollment_id` | UUID (FK) | Да | Запись на курс |
| `student_id` | UUID (FK) | Да | Слушатель (денормализация для быстрого поиска) |
| `certificate_number` | String(50) | Да | Серийный номер (уникальный) |
| `issue_date` | Date | Да | Дата выдачи |
| `pdf_file` | File | Да | PDF-файл сертификата |
| `verification_url` | String(255) | Нет | Публичная ссылка для проверки подлинности |
| `status` | Enum | Да | Статус: `issued` / `revoked` |
| `created_at` | DateTime | Да | Дата создания |

**Связи:**
- Многие-к-одному: Certificate Instance → Certificate Template
- Один-к-одному: Certificate Instance → Enrollment
- Многие-к-одному: Certificate Instance → User (прямая связь с пользователем-получателем)

**Статусная модель:**
- `issued`: Выдан. Сертификат действителен.
- `revoked`: Отозван. Сертификат аннулирован (редкий случай).

**Переходы статусов:**
- `issued → revoked`: Администратор отзывает сертификат (например, при обнаружении нарушений)

**BPMN-процесс (выдача сертификата):**
1. При завершении курса проверяется условие: `enrollment.total_score >= course_template.certification_threshold`
2. Если да:
   - Создается Certificate Instance
   - Генерируется уникальный `certificate_number`
   - Через конструктор печатных форм B3 создается PDF
   - Сертификат привязывается к профилю студента
   - Отправляется уведомление

**Бизнес-правила:**
- `certificate_number` формируется по паттерну: `B3-{YEAR}-{COURSE_CODE}-{SEQUENCE}` (например, `B3-2025-B3-101-00042`)
- `verification_url` позволяет внешним организациям проверить подлинность

---

### 3.6. Уведомления

#### 3.6.1. Уведомление (Notification)

**Описание:** Уведомление для пользователя о событиях в системе.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `user_id` | UUID (FK) | Да | Получатель |
| `type` | Enum | Да | `assignment_graded` / `new_message` / `deadline_soon` / `certificate_issued` / `enrollment_approved` |
| `title` | String(255) | Да | Заголовок |
| `message` | Text | Да | Текст уведомления |
| `link` | String(255) | Нет | Ссылка на связанный объект |
| `is_read` | Boolean | Да | Прочитано ли (default: false) |
| `created_at` | DateTime | Да | Дата создания |

**Связи:**
- Многие-к-одному: Notification → User

**Типы уведомлений:**
- `assignment_graded`: Задание проверено
- `new_message`: Новое сообщение в диалоге
- `deadline_soon`: Приближается дедлайн задания (за 2 дня)
- `certificate_issued`: Сертификат выдан
- `enrollment_approved`: Заявка на курс одобрена

**Бизнес-правила:**
- Уведомления создаются автоматически BPMN-процессами
- Может быть настроена доставка через email/push (интеграция)
- Автоматическое удаление прочитанных уведомлений старше 90 дней (опционально)

**Примечание:**
Для уведомлений не требуется сложная статусная модель, достаточно флага `is_read`.

---

### 3.7. Графики

#### 3.7.1. График заданий (Assignment Schedule)

**Описание:** Определяет временные параметры задания в рамках шаблона курса: длительность выполнения, условие старта и отсрочку. Эти параметры используются для автоматического расчета дат при создании учебной группы.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `assignment_template_id` | UUID (FK) | Да | Шаблон задания |
| `duration_days` | Integer | Да | Длительность задания (дней на выполнение) |
| `start_condition` | Enum | Да | Условие старта: `course_start` / `prev_complete` / `manual` |
| `start_offset_days` | Integer | Нет | Дней отсрочки от условия (по умолчанию 0) |

**Связи:**
- Один-к-одному: Assignment Schedule → Assignment Template (каждое задание имеет один график)

**Типы условий старта (`start_condition`):**
- `course_start`: Задание доступно от старта курса + `start_offset_days`
- `prev_complete`: Задание открывается после выполнения предыдущего задания + `start_offset_days`
- `manual`: Задание открывается вручную преподавателем (даты игнорируются)

**Вычисление дат для учебной группы:**

При создании Course Instance система автоматически вычисляет конкретные даты:

```
Если start_condition = course_start:
  start_date = course_instance.start_date + start_offset_days
  end_date = start_date + duration_days

Если start_condition = prev_complete:
  start_date = prev_assignment.end_date + start_offset_days
  end_date = start_date + duration_days

Если start_condition = manual:
  start_date = NULL (устанавливается преподавателем)
  end_date = start_date + duration_days (после установки)
```

**Бизнес-правила:**
- Каждый Assignment Template должен иметь ровно один Assignment Schedule
- `start_offset_days` позволяет создавать "дни отдыха" между заданиями или запускать задание не сразу
- При `prev_complete` порядок заданий определяется полем `order_number` в Assignment Template
- График задается методистом при создании шаблона курса

**Пример:**

| Задание | duration_days | start_condition | start_offset_days | Результат (курс с 01.02) |
|---------|---------------|-----------------|-------------------|--------------------------|
| Лекция 1 | 3 | course_start | 0 | 01.02 - 04.02 |
| Практика 1 | 7 | prev_complete | 1 | 05.02 - 12.02 |
| Лекция 2 | 3 | prev_complete | 0 | 12.02 - 15.02 |
| Проект | 14 | course_start | 7 | 08.02 - 22.02 |

---

#### 3.7.2. График запуска (Launch Schedule)

**Описание:** Определяет автоматический запуск учебных групп по шаблону курса. Позволяет настроить периодический или плановый запуск новых групп.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `course_template_id` | UUID (FK) | Да | Шаблон курса |
| `launch_mode` | Enum | Да | `manual` / `periodic` / `dates` |
| `period` | Enum | Нет | `weekly` / `biweekly` / `monthly` / `quarterly` (если periodic) |
| `launch_day` | Integer | Нет | День запуска (1-7 для недели, 1-31 для месяца) |
| `min_students` | Integer | Нет | Минимум студентов для автозапуска |
| `planned_dates` | JSON | Нет | Массив запланированных дат (если dates) |
| `is_active` | Boolean | Да | Активен ли график |

**Связи:**
- Многие-к-одному: Launch Schedule → Course Template

**Режимы запуска:**
- `manual`: Группы создаются вручную методистом/администратором
- `periodic`: Автоматический запуск с заданной периодичностью
- `dates`: Запуск в конкретные запланированные даты

**Бизнес-правила:**
- Если `launch_mode = periodic`, обязательны поля `period` и `launch_day`
- Если `launch_mode = dates`, обязательно поле `planned_dates`
- `min_students` используется для проверки минимального количества записей перед автозапуском
- BPMN-процесс проверяет расписание и создает Course Instance автоматически

**Примечание:**
Эта сущность позволяет автоматизировать запуск популярных курсов без ручного вмешательства администратора.

---

## 4. Паттерны Template → Instance

### 4.1. Принцип разделения

**Template (Шаблон):**
- Создается один раз методистом
- Хранит определение структуры
- Может обновляться без влияния на активные экземпляры
- Переиспользуется для множества учебных групп

**Instance (Экземпляр):**
- Создается для конкретной учебной группы/студента
- Содержит индивидуальные данные (прогресс, оценки)
- Изолирован от других экземпляров
- Ссылается на шаблон через foreign key

### 4.2. Примеры применения

#### Курсы

```
Шаблон курса "B3 Базовый уровень"
    ├─► Экземпляр курса "Группа октябрь 2025" (преподаватель Иванов)
    ├─► Экземпляр курса "Группа декабрь 2025" (преподаватель Петров)
    └─► Экземпляр курса "Корпоративная группа ГосКорп" (преподаватель Сидоров)
```

#### Задания

```
Шаблон задания "Лабораторная работа 1: Создание формы"
    ├─► Экземпляр задания (Студент Петров, Группа октябрь)
    │       status: completed, grade: 85
    ├─► Экземпляр задания (Студент Сидорова, Группа октябрь)
    │       status: under_review, awaiting review
    └─► Экземпляр задания (Студент Иванов, Группа декабрь)
            status: in_progress
```

#### Сертификаты

```
Шаблон сертификата "Базовый уровень"
    ├─► Экземпляр сертификата (Студент Петров, B3-2025-B3-101-00001)
    ├─► Экземпляр сертификата (Студент Иванова, B3-2025-B3-101-00002)
    └─► Экземпляр сертификата (Студент Смирнов, B3-2025-B3-101-00003)
```

### 4.3. Преимущества паттерна

1. **Переиспользование контента**: Один шаблон → множество запусков
2. **Изоляция данных**: Изменения в одном экземпляре не влияют на другие
3. **Версионирование**: Можно обновить шаблон для будущих групп, не трогая текущие
4. **Аналитика**: Легко сравнивать разные группы одного курса
5. **Масштабируемость**: Добавление новых групп не требует копирования контента

---

## 5. Статусная модель

### 5.1. Course Template (Шаблон курса)

#### Статусы

| Статус | Описание | Видимость | Доступ |
|--------|----------|-----------|--------|
| `draft` | Черновик (начальное состояние). Курс находится в разработке. | Виден только методисту-автору и администраторам | Полное редактирование (методист). Просмотр и управление (администратор) |
| `published` | Опубликован. Курс доступен для создания учебных групп и регистрации студентов. | Виден в каталоге согласно `accessibility`: `public` - всем пользователям, `registered` - авторизованным | Только просмотр (студенты, преподаватели). Снятие с публикации (методист, администратор) |
| `archived` | Архивирован. Курс скрыт, сохраняется только для истории. | Виден только администраторам в архиве | Только просмотр (администратор) |

#### Переходы

| Переход | Инициатор | Условия | Действия при переходе |
|---------|-----------|---------|----------------------|
| `draft → published` | Методист | Обязательные поля заполнены, минимум 1 задание в курсе | Курс появляется в каталоге, шаблон становится read-only |
| `published → draft` | Методист/Администратор | Нет активных учебных групп (`course_instance.status != active`) | Курс скрывается из каталога, шаблон становится редактируемым |
| `published → archived` | Методист/Администратор | Нет активных учебных групп | Курс полностью скрывается из каталога и списков |
| `draft → archived` | Методист/Администратор | - | Черновик удаляется из рабочих списков |

**Детализация переходов:**

**draft → published:**
- **Триггер:** Методист вручную публикует курс через кнопку "Опубликовать"
- **Видимость:** Курс появляется в каталоге курсов согласно настройке `accessibility` (`public` - для всех, `registered` - для авторизованных пользователей)
- **Доступ:** Шаблон курса становится read-only для методиста (редактирование возможно только после снятия с публикации). Студенты и преподаватели могут просматривать описание курса
- **Дочерние объекты:** -
- **Уведомления:** -
- **Обновляемые поля:** `status = published`, `updated_at = текущее время`
- **Валидация:** Обязательные поля `title`, `description`, `level`, `certification_threshold` должны быть заполнены. Курс должен содержать минимум 1 задание (`assignment_template`)
- **Обновление родительских объектов:** -

**published → draft:**
- **Триггер:** Методист/Администратор вручную снимает курс с публикации
- **Видимость:** Курс скрывается из каталога, остается видимым только методисту и администраторам
- **Доступ:** Шаблон становится редактируемым для методиста
- **Дочерние объекты:** -
- **Уведомления:** -
- **Обновляемые поля:** `status = draft`, `updated_at = текущее время`
- **Валидация:** Не должно быть активных учебных групп (`course_instance` со статусом `active` или `planned`). Если есть активные группы - переход блокируется с предупреждением
- **Обновление родительских объектов:** -

**published → archived:**
- **Триггер:** Методист/Администратор вручную архивирует курс
- **Видимость:** Курс полностью скрывается из каталога и всех списков, доступен только администраторам в разделе архива
- **Доступ:** Только просмотр для администраторов
- **Дочерние объекты:** Все связанные `assignment_template` переходят в статус `archived`
- **Уведомления:** -
- **Обновляемые поля:** `status = archived`, `updated_at = текущее время`
- **Валидация:** Не должно быть активных учебных групп (`course_instance` со статусом `active` или `planned`)
- **Обновление родительских объектов:** -

**draft → archived:**
- **Триггер:** Методист/Администратор удаляет черновик курса
- **Видимость:** Курс скрывается из рабочих списков
- **Доступ:** Только просмотр для администраторов в архиве
- **Дочерние объекты:** Все связанные `assignment_template` переходят в статус `archived`
- **Уведомления:** -
- **Обновляемые поля:** `status = archived`, `updated_at = текущее время`
- **Валидация:** -
- **Обновление родительских объектов:** -

---

### 5.2. Course Instance (Экземпляр курса / Учебная группа)

#### Статусы

| Статус | Описание | Видимость | Доступ |
|--------|----------|-----------|--------|
| `planned` | Запланирован. Учебная группа создана, но обучение еще не началось. | Виден преподавателю группы, записанным студентам, администраторам | Преподаватель: настройка группы, управление записями. Студенты: просмотр описания курса, но недоступен контент заданий. Администратор: полное управление |
| `active` | Активен. Идет обучение, студенты работают над заданиями. | Виден всем участникам группы (студенты, преподаватель, администраторы) | Студенты: выполнение заданий, просмотр материалов. Преподаватель: проверка работ, общение, управление группой. Администратор: полное управление |
| `completed` | Завершен. Обучение окончено, все процессы завершены. | Виден участникам, но помечен как завершенный | Студенты: только просмотр своих работ и результатов. Преподаватель: просмотр итогов, выгрузка отчетов. Администратор: управление архивацией |
| `archived` | Архивирован. Группа скрыта из активных списков, сохранена для истории. | Виден только администраторам и преподавателю (в архиве) | Только просмотр для всех ролей |

#### Переходы

| Переход | Инициатор | Условия | Действия при переходе |
|---------|-----------|---------|----------------------|
| `planned → active` | Автоматически (по расписанию) / Преподаватель (вручную) | Наступила дата `start_date` ИЛИ преподаватель вручную активирует группу | Все одобренные записи активируются, создаются экземпляры заданий, уведомления студентам |
| `active → completed` | Автоматически (по расписанию) / Преподаватель (вручную) | Наступила дата `end_date` ИЛИ преподаватель завершает курс вручную | Запуск процесса сертификации, закрытие приема работ, уведомления студентам |
| `completed → archived` | Администратор | - | Группа скрывается из активных списков |

**Детализация переходов:**

**planned → active:**
- **Триггер:** Автоматически по расписанию при наступлении `start_date` (BPMN-процесс проверяет ежедневно) ИЛИ вручную преподавателем через кнопку "Начать курс"
- **Видимость:** Студенты получают полный доступ к контенту курса, заданиям и материалам
- **Доступ:** Студенты могут начинать выполнение заданий. Преподаватель может проверять работы
- **Дочерние объекты:** Для каждой записи (`enrollment` в статусе `approved`) автоматически создаются все `assignment_instance` на основе шаблонов заданий курса (если еще не созданы)
- **Уведомления:** Всем студентам с `enrollment.status = approved` отправляется уведомление (type: `course_started`) "Курс начался. Приступайте к выполнению заданий"
- **Обновляемые поля:** `status = active`, `actual_start_date = текущая дата`
- **Валидация:** -
- **Обновление родительских объектов:** Все `enrollment` со статусом `approved` автоматически переходят в статус `active` (каскадный переход)

**active → completed:**
- **Триггер:** Автоматически при наступлении `end_date` (BPMN-процесс) ИЛИ вручную преподавателем через кнопку "Завершить курс"
- **Видимость:** Контент курса остается видимым студентам, но помечен как завершенный. Курс перемещается в раздел "Завершенные курсы" в интерфейсе студента
- **Доступ:** Студенты больше не могут сдавать новые работы или редактировать существующие. Все `assignment_instance` в статусах `in_progress` или `under_review` остаются в текущих статусах (преподаватель может их доработать)
- **Дочерние объекты:** -
- **Уведомления:** Всем студентам отправляется уведомление (type: `course_completed`) "Курс завершен"
- **Обновляемые поля:** `status = completed`, `actual_end_date = текущая дата`
- **Валидация:** -
- **Обновление родительских объектов:** Запускается BPMN-процесс проверки условий завершения для всех `enrollment`: если `total_score >= course_template.certification_threshold` И все обязательные задания в статусе `completed`, то `enrollment.status = completed` и создается `certificate_instance`. Иначе `enrollment.status = failed`

**completed → archived:**
- **Триггер:** Администратор вручную архивирует группу (обычно через несколько месяцев после завершения)
- **Видимость:** Группа скрывается из активных списков преподавателя и студентов, доступна только в разделе архива
- **Доступ:** Только просмотр для всех ролей (студент видит свои результаты, преподаватель видит итоговую статистику)
- **Дочерние объекты:** -
- **Уведомления:** -
- **Обновляемые поля:** `status = archived`
- **Валидация:** -
- **Обновление родительских объектов:** -

---

### 5.3. Enrollment (Запись на курс)

#### Статусы

| Статус | Описание | Видимость | Доступ |
|--------|----------|-----------|--------|
| `created` | Создана (черновик). Студент добавил курс в список, но не отправил на согласование. | Видна только студенту (свои черновики) | Студент: редактирование комментария, отправка на согласование, удаление |
| `pending_approval` | Ожидает согласования. Студент подал заявку на курс. | Видна студенту (свои заявки), администраторам, преподавателю курса | Студент: может отменить заявку. Администратор: может одобрить/отклонить, заполнить комментарий |
| `approved` | Согласована, ожидает старта курса. | Видна студенту, преподавателю, администраторам | Студент: просмотр описания курса. Преподаватель/Администратор: управление группой |
| `rejected` | Отклонена администратором. | Видна студенту (с причиной отклонения), администраторам | Студент: может редактировать и повторно отправить. Администратор: только просмотр |
| `active` | Активная запись. Студент проходит курс. | Видна всем участникам курса | Студент: выполнение заданий, общение с преподавателем. Преподаватель: проверка работ, общение. Администратор: управление записью |
| `completed` | Курс успешно пройден. | Видна студенту, преподавателю, администраторам | Только просмотр своих результатов и сертификата |
| `withdrawn` | Отчислен с курса. | Видна студенту, преподавателю, администраторам | Только просмотр |
| `failed` | Курс не пройден (не выполнены условия сертификации). | Видна студенту, преподавателю, администраторам | Только просмотр |

#### Переходы

| Переход | Инициатор | Условия | Действия при переходе |
|---------|-----------|---------|----------------------|
| [создание] → `created` | Студент | Студент нажимает "Добавить в мои курсы" / "Отложить" | Создается черновик записи |
| `created → pending_approval` | Студент | Студент нажимает "Отправить на согласование" | Заявка отправлена, уведомление администраторам |
| `created → [удалена]` | Студент | Студент удаляет черновик | Запись удаляется |
| `pending_approval → approved` | Администратор | - | Заявка одобрена, запись ждет старта курса, уведомление студенту |
| `pending_approval → rejected` | Администратор | - | Заявка отклонена с комментарием, уведомление студенту |
| `rejected → created` | Студент | Студент редактирует отклоненную заявку | Заявка возвращается в черновик для доработки |
| `approved → rejected` | Администратор | До старта курса | Администратор отзывает согласование, уведомление студенту |
| `approved → active` | Автоматически | `course_instance.status = active` | Создание экземпляров заданий, полный доступ к курсу |
| `active → completed` | Автоматически | Все обязательные задания `completed` И `total_score >= certification_threshold` | Создание сертификата, уведомление студенту |
| `active → withdrawn` | Студент / Администратор | - | Отчисление с курса, блокировка заданий |
| `active → failed` | Автоматически | `course_instance.status = completed` И условия сертификации НЕ выполнены | Уведомление о неуспешном завершении |

**Детализация переходов:**

**[создание] → created:**
- **Триггер:** Студент нажимает кнопку "Добавить в мои курсы" / "Отложить" в каталоге курсов
- **Видимость:** Запись видна только студенту в разделе "Мои черновики заявок"
- **Доступ:** Студент может редактировать комментарий, отправить на согласование или удалить
- **Дочерние объекты:** Создается запись `enrollment` со статусом `created`
- **Уведомления:** -
- **Обновляемые поля:** `enrolled_at = текущее время`, `request_comment` (если студент оставил комментарий)
- **Валидация:** Студент не должен быть уже записан на этот экземпляр курса
- **Обновление родительских объектов:** -

**created → pending_approval:**
- **Триггер:** Студент нажимает кнопку "Отправить на согласование"
- **Видимость:** Заявка становится видна администраторам в списке "Заявки на регистрацию", преподавателю курса
- **Доступ:** Студент может отменить заявку (вернуть в `created`). Администратор может одобрить/отклонить
- **Дочерние объекты:** -
- **Уведомления:** Администраторам и преподавателю курса отправляется уведомление (type: `enrollment_request`) "Новая заявка на курс от [Имя студента]"
- **Обновляемые поля:** `status = pending_approval`, `submitted_at = текущее время`
- **Валидация:** -
- **Обновление родительских объектов:** -

**pending_approval → approved:**
- **Триггер:** Администратор нажимает кнопку "Одобрить заявку"
- **Видимость:** Запись появляется в списке студентов курса у преподавателя. Студент видит одобренную запись в разделе "Мои курсы" (с пометкой "Ожидает начала")
- **Доступ:** Студент может просматривать описание курса, но задания еще недоступны
- **Дочерние объекты:** -
- **Уведомления:** Студенту отправляется уведомление (type: `enrollment_approved`) "Ваша заявка на курс одобрена. Курс начнется [дата start_date]"
- **Обновляемые поля:** `status = approved`, `approved_by = user_id администратора`, `approved_at = текущее время`, `approval_comment` (если администратор оставил комментарий)
- **Валидация:** -
- **Обновление родительских объектов:** -

**pending_approval → rejected:**
- **Триггер:** Администратор нажимает кнопку "Отклонить заявку" и указывает причину
- **Видимость:** Запись помечается как отклоненная, видна студенту с причиной отклонения
- **Доступ:** Студент может редактировать комментарий и повторно отправить (переход в `created`)
- **Дочерние объекты:** -
- **Уведомления:** Студенту отправляется уведомление (type: `enrollment_rejected`) "Ваша заявка на курс отклонена. Причина: [текст из approval_comment]"
- **Обновляемые поля:** `status = rejected`, `approved_by = user_id администратора`, `approved_at = текущее время`, `approval_comment` (обязательно - причина отклонения)
- **Валидация:** -
- **Обновление родительских объектов:** -

**rejected → created:**
- **Триггер:** Студент нажимает кнопку "Редактировать заявку" на отклоненной заявке
- **Видимость:** Запись возвращается в черновики студента
- **Доступ:** Студент может редактировать комментарий и повторно отправить на согласование
- **Дочерние объекты:** -
- **Уведомления:** -
- **Обновляемые поля:** `status = created`, очищаются `approved_by`, `approved_at`
- **Валидация:** -
- **Обновление родительских объектов:** -
- **Примечание:** Сохраняется `approval_comment` с предыдущим отклонением для справки

**approved → rejected:**
- **Триггер:** Администратор отзывает согласование до старта курса
- **Видимость:** Запись помечается как отклоненная, видна студенту с причиной отзыва
- **Доступ:** Студент может редактировать и повторно отправить
- **Дочерние объекты:** -
- **Уведомления:** Студенту отправляется уведомление (type: `enrollment_revoked`) "Согласование вашей заявки на курс отозвано. Причина: [текст]"
- **Обновляемые поля:** `status = rejected`, `approved_by = user_id администратора`, `approved_at = текущее время`, `approval_comment` (причина отзыва)
- **Валидация:** `course_instance.status` должен быть `planned` (курс еще не начался)
- **Обновление родительских объектов:** -

**approved → active:**
- **Триггер:** Автоматически при переходе `course_instance.status → active` (BPMN-процесс обрабатывает все одобренные записи)
- **Видимость:** Студент получает полный доступ к контенту курса и видит все задания
- **Доступ:** Студент может выполнять задания, отправлять работы на проверку, общаться с преподавателем
- **Дочерние объекты:** Автоматически создаются все `assignment_instance` для этого студента на основе `assignment_template` курса (связь: `enrollment_id + assignment_template_id`). Каждый экземпляр создается в статусе `not_started`
- **Уведомления:** Студенту отправляется уведомление (type: `course_started`) "Курс [название] начался. Приступайте к выполнению заданий"
- **Обновляемые поля:** `status = active`, `started_at = текущее время`, `progress_percentage = 0`, `total_score = 0`
- **Валидация:** -
- **Обновление родительских объектов:** -

**active → completed:**
- **Триггер:** Автоматически при выполнении условий завершения (BPMN-процесс проверяет при каждом обновлении `assignment_instance.status → completed`)
- **Видимость:** Запись помечается как завершенная, курс перемещается в раздел "Завершенные курсы" у студента
- **Доступ:** Только просмотр своих работ и результатов, доступ к сертификату
- **Дочерние объекты:** Создается `certificate_instance` (если условия сертификации выполнены): генерируется уникальный `certificate_number`, создается PDF через конструктор печатных форм B3, заполняется поле `pdf_file`
- **Уведомления:** Студенту отправляется уведомление (type: `course_completed_success`) "Поздравляем! Вы успешно завершили курс [название]. Ваш итоговый балл: [total_score]. Сертификат доступен для скачивания"
- **Обновляемые поля:** `status = completed`, `completion_date = текущая дата`, `total_score` (финальное значение), `progress_percentage = 100`
- **Валидация:** Все обязательные задания (`assignment_template.is_mandatory = true`) должны быть в статусе `completed` И `total_score >= course_template.certification_threshold`
- **Обновление родительских объектов:** -

**active → withdrawn:**
- **Триггер:** Студент нажимает "Отчислиться с курса" (с подтверждением) ИЛИ Администратор/Преподаватель отчисляет студента вручную
- **Видимость:** Запись помечается как отчисленная, курс перемещается в раздел "Отчисленные" у студента
- **Доступ:** Только просмотр своих работ на момент отчисления
- **Дочерние объекты:** -
- **Уведомления:** Преподавателю отправляется уведомление (type: `student_withdrawn`) "Студент [имя] отчислился с курса [название]"
- **Обновляемые поля:** `status = withdrawn`, `completion_date = текущая дата` (дата отчисления)
- **Валидация:** -
- **Обновление родительских объектов:** -

**active → failed:**
- **Триггер:** Автоматически при переходе `course_instance.status → completed`, если условия сертификации НЕ выполнены (BPMN-процесс проверяет все активные записи)
- **Видимость:** Запись помечается как проваленная, курс перемещается в раздел "Не завершенные курсы" у студента
- **Доступ:** Только просмотр своих работ
- **Дочерние объекты:** -
- **Уведомления:** Студенту отправляется уведомление (type: `course_failed`) "Курс [название] завершен. К сожалению, условия для получения сертификата не выполнены. Ваш балл: [total_score], требуется: [certification_threshold]"
- **Обновляемые поля:** `status = failed`, `completion_date = текущая дата`
- **Валидация:** -
- **Обновление родительских объектов:** -

---

### 5.4. Assignment Template (Шаблон задания)

#### Статусы

| Статус | Описание | Видимость | Доступ |
|--------|----------|-----------|--------|
| `draft` | Черновик. Задание находится в разработке. | Видно только методисту-автору курса и администраторам | Полное редактирование (методист) |
| `active` | Активен. Задание используется в курсе и доступно для создания экземпляров. | Видно методисту, преподавателям, администраторам | Только просмотр (редактирование через снятие курса с публикации) |
| `archived` | Архивирован. Задание больше не используется в новых группах. | Видно только администраторам в архиве | Только просмотр |

#### Переходы

| Переход | Инициатор | Условия | Действия при переходе |
|---------|-----------|---------|----------------------|
| `draft → active` | Автоматически / Методист | Родительский `course_template.status = published` ИЛИ методист активирует задание | Задание доступно для использования в учебных группах |
| `active → archived` | Методист | Родительский `course_template.status = draft` ИЛИ задание удаляется из курса | Задание скрывается из активных, сохраняется в существующих экземплярах |

**Детализация переходов:**

**draft → active:**
- **Триггер:** Автоматически при публикации родительского `course_template` (переход `draft → published`) ИЛИ вручную методистом при активации задания
- **Видимость:** Задание становится видимым в структуре курса для всех ролей
- **Доступ:** Шаблон задания становится read-only (редактирование только через снятие курса с публикации)
- **Дочерние объекты:** -
- **Уведомления:** -
- **Обновляемые поля:** `status = active`, `updated_at = текущее время`
- **Валидация:** -
- **Обновление родительских объектов:** -

**active → archived:**
- **Триггер:** Методист удаляет задание из курса ИЛИ архивирует курс (родительский `course_template` переходит в `archived`)
- **Видимость:** Задание скрывается из списка активных заданий курса
- **Доступ:** Только просмотр для истории
- **Дочерние объекты:** -
- **Уведомления:** -
- **Обновляемые поля:** `status = archived`, `updated_at = текущее время`
- **Валидация:** Родительский `course_template.status` должен быть `draft` (курс снят с публикации) ИЛИ `archived`
- **Обновление родительских объектов:** -
- **Примечание:** Уже созданные `assignment_instance` на основе этого шаблона продолжают существовать и работать

---

### 5.5. Assignment Instance (Экземпляр задания)

#### Статусы

| Статус | Описание | Видимость | Доступ |
|--------|----------|-----------|--------|
| `not_started` | Не начато. Студент еще не открыл задание для выполнения. | Видно студенту в списке заданий, преподавателю | Студент: может открыть для начала работы. Преподаватель: только просмотр |
| `in_progress` | В работе. Студент работает над заданием. | Видно студенту, преподавателю | Студент: может редактировать submission, сохранить черновик, отправить на проверку. Преподаватель: только просмотр |
| `under_review` | На проверке. Преподаватель проверяет работу. | Видно студенту, преподавателю | Студент: только просмотр. Преподаватель: может выставить оценку, оставить комментарий, принять или вернуть на доработку |
| `completed` | Завершено. Работа проверена и оценена, или автозачтена. | Видно студенту, преподавателю | Только просмотр для обеих ролей |
| `needs_revision` | Требует доработки. Преподаватель вернул работу на исправление. | Видно студенту, преподавателю | Студент: может редактировать submission и повторно отправить. Преподаватель: только просмотр |

#### Переходы

| Переход | Инициатор | Условия | Действия при переходе |
|---------|-----------|---------|----------------------|
| [создание] → `not_started` | Автоматически | При активации `enrollment` | Создание экземпляра задания |
| `not_started → in_progress` | Студент | Студент открывает задание | Фиксация начала работы |
| `in_progress → under_review` | Студент | Студент нажимает "Отправить на проверку" | Работа заблокирована, уведомление преподавателю, создание BPMN-задачи |
| `in_progress → completed` | Автоматически | Тип задания `lecture` или `autoGrade=true` | Автозачёт с максимальным баллом, пересчет прогресса |
| `under_review → completed` | Преподаватель | Преподаватель выставляет оценку и принимает | Обновление оценки, уведомление студенту, пересчет прогресса |
| `under_review → needs_revision` | Преподаватель | Преподаватель возвращает на доработку | Работа разблокирована, уведомление студенту |
| `needs_revision → in_progress` | Студент | Студент начинает доработку | Инкремент счетчика попыток |

**Детализация переходов:**

**[создание] → not_started:**
- **Триггер:** Автоматически при переходе родительского `enrollment.status → active` (BPMN-процесс создает все экземпляры заданий для студента)
- **Видимость:** Задание появляется в списке заданий студента
- **Доступ:** Студент видит название, описание, дедлайн, но еще не может редактировать submission
- **Дочерние объекты:** Создается запись `assignment_instance`
- **Уведомления:** -
- **Обновляемые поля:** При создании: `status = not_started`, `attempt_count = 0`
- **Валидация:** -
- **Обновление родительских объектов:** -

**not_started → in_progress:**
- **Триггер:** Студент открывает задание для выполнения (нажимает кнопку "Начать работу" или просто начинает вводить текст решения)
- **Видимость:** Без изменений
- **Доступ:** Студент получает возможность редактировать поля `submission_text`, `submission_files`, `submission_url`
- **Дочерние объекты:** -
- **Уведомления:** -
- **Обновляемые поля:** `status = in_progress`, `started_at = текущее время`
- **Валидация:** -
- **Обновление родительских объектов:** Обновляется `enrollment.last_activity_at = текущее время`

**in_progress → under_review:**
- **Триггер:** Студент нажимает кнопку "Отправить на проверку"
- **Видимость:** Задание помечается как "На проверке" в интерфейсе студента
- **Доступ:** Студент больше не может редактировать submission (поля блокируются). Преподаватель получает доступ к выставлению оценки
- **Дочерние объекты:** Создается BPMN-задача для преподавателя "Проверить задание [название] студента [имя]"
- **Уведомления:** Преподавателю курса отправляется уведомление (type: `assignment_submitted`) "Студент [имя] сдал задание [название]. Требуется проверка"
- **Обновляемые поля:** `status = under_review`, `submitted_at = текущее время`, `attempt_count = attempt_count + 1`
- **Валидация:** Хотя бы одно из полей `submission_text`, `submission_files`, `submission_url` должно быть заполнено (согласно `assignment_template.submission_type`)
- **Обновление родительских объектов:** Обновляется `enrollment.last_activity_at = текущее время`

**in_progress → completed (автозачёт):**
- **Триггер:** Автоматически при выполнении условий автозачёта (для заданий типа `lecture` или с флагом `autoGrade=true`)
- **Видимость:** Задание помечается как "Завершено" в интерфейсе студента, отображается оценка
- **Доступ:** Только просмотр для обеих ролей (работа закрыта)
- **Дочерние объекты:** -
- **Уведомления:** Студенту отправляется уведомление (type: `assignment_completed`) "Задание [название] зачтено автоматически"
- **Обновляемые поля:** `status = completed`, `grade = max_score`, `graded_at = текущее время`, `graded_by = null` (система)
- **Валидация:** `assignment_template.type = lecture` ИЛИ `assignment_template.autoGrade = true`
- **Обновление родительских объектов:** Пересчитываются поля в родительском `enrollment`:
  - `progress_percentage` = (количество `assignment_instance` в статусе `completed`) / (общее количество заданий) × 100
  - `total_score` = среднее значение `grade / max_score` по всем обязательным заданиям в статусе `completed`
  - `enrollment.last_activity_at = текущее время`
  - Если все обязательные задания завершены И `total_score >= certification_threshold`, запускается проверка условий для перехода `enrollment → completed`

**under_review → completed:**
- **Триггер:** Преподаватель выставляет оценку и нажимает кнопку "Принять работу" / "Поставить оценку"
- **Видимость:** Задание помечается как "Завершено" в интерфейсе студента, отображается оценка
- **Доступ:** Только просмотр для обеих ролей (работа закрыта)
- **Дочерние объекты:** -
- **Уведомления:** Студенту отправляется уведомление (type: `assignment_graded`) "Ваша работа по заданию [название] проверена. Оценка: [grade] из [max_score]. [Ссылка на задание для просмотра комментария]"
- **Обновляемые поля:** `status = completed`, `grade = [значение от преподавателя]`, `feedback = [текст комментария]`, `graded_at = текущее время`, `graded_by = user_id преподавателя`
- **Валидация:** Поле `grade` должно быть в диапазоне от 0 до `assignment_template.max_score`
- **Обновление родительских объектов:** Пересчитываются поля в родительском `enrollment`:
  - `progress_percentage` = (количество `assignment_instance` в статусе `completed`) / (общее количество заданий) × 100
  - `total_score` = среднее значение `grade / max_score` по всем обязательным заданиям в статусе `completed`
  - `enrollment.last_activity_at = текущее время`
  - Если все обязательные задания завершены И `total_score >= certification_threshold`, запускается проверка условий для перехода `enrollment → completed`

**under_review → needs_revision:**
- **Триггер:** Преподаватель нажимает кнопку "Вернуть на доработку" и оставляет комментарий с замечаниями
- **Видимость:** Задание помечается как "Требует доработки" в интерфейсе студента
- **Доступ:** Студент снова получает возможность редактировать submission
- **Дочерние объекты:** -
- **Уведомления:** Студенту отправляется уведомление (type: `assignment_needs_revision`) "Ваша работа по заданию [название] требует доработки. Комментарий преподавателя: [feedback]. [Ссылка на задание]"
- **Обновляемые поля:** `status = needs_revision`, `feedback = [текст комментария преподавателя]`, `graded_at = текущее время`, `graded_by = user_id преподавателя`
- **Валидация:** Поле `feedback` обязательно должно быть заполнено (объяснение причины возврата)
- **Обновление родительских объектов:** Обновляется `enrollment.last_activity_at = текущее время`

**needs_revision → in_progress:**
- **Триггер:** Студент нажимает кнопку "Приступить к исправлениям" или начинает редактировать submission
- **Видимость:** Задание помечается как "В работе (доработка)" в интерфейсе студента
- **Доступ:** Студент может редактировать submission, видит предыдущий комментарий преподавателя
- **Дочерние объекты:** -
- **Уведомления:** -
- **Обновляемые поля:** `status = in_progress` (счетчик `attempt_count` НЕ инкрементируется - инкремент будет при повторной отправке)
- **Валидация:** -
- **Обновление родительских объектов:** Обновляется `enrollment.last_activity_at = текущее время`

---

### 5.6. Certificate Template (Шаблон сертификата)

#### Статусы

| Статус | Описание | Видимость | Доступ |
|--------|----------|-----------|--------|
| `draft` | Черновик. Шаблон находится в разработке. | Виден только администраторам | Полное редактирование (администратор) |
| `active` | Активен. Шаблон используется для выдачи сертификатов. | Виден администраторам, методистам (при настройке курсов) | Только просмотр (редактирование через архивацию) |
| `archived` | Архивирован. Шаблон больше не используется для новых сертификатов. | Виден только администраторам в архиве | Только просмотр |

#### Переходы

| Переход | Инициатор | Условия | Действия при переходе |
|---------|-----------|---------|----------------------|
| `draft → active` | Администратор | Печатная форма B3 настроена и протестирована | Шаблон доступен для использования в курсах |
| `active → archived` | Администратор | Нет активных курсов, использующих этот шаблон (рекомендация) | Шаблон скрывается из выбора при настройке курсов |

**Детализация переходов:**

**draft → active:**
- **Триггер:** Администратор нажимает кнопку "Активировать шаблон" после настройки печатной формы
- **Видимость:** Шаблон появляется в списке доступных шаблонов сертификатов при настройке курсов
- **Доступ:** Шаблон становится read-only (редактирование только через архивацию и создание новой версии)
- **Дочерние объекты:** -
- **Уведомления:** -
- **Обновляемые поля:** `status = active`
- **Валидация:** Поле `print_form_id` должно быть заполнено (ссылка на печатную форму B3 должна существовать)
- **Обновление родительских объектов:** -

**active → archived:**
- **Триггер:** Администратор архивирует устаревший шаблон (например, при смене дизайна сертификатов)
- **Видимость:** Шаблон скрывается из списка доступных при настройке новых курсов
- **Доступ:** Только просмотр
- **Дочерние объекты:** -
- **Уведомления:** -
- **Обновляемые поля:** `status = archived`
- **Валидация:** -
- **Обновление родительских объектов:** -
- **Примечание:** Уже выданные сертификаты (`certificate_instance`) на основе этого шаблона продолжают быть действительными

---

### 5.7. Certificate Instance (Экземпляр сертификата)

#### Статусы

| Статус | Описание | Видимость | Доступ |
|--------|----------|-----------|--------|
| `issued` | Выдан. Сертификат действителен. | Виден студенту (в разделе "Мои сертификаты"), преподавателю курса, администраторам. Публично доступен по `verification_url` | Студент: просмотр, скачивание PDF. Администратор: управление (отзыв в редких случаях) |
| `revoked` | Отозван. Сертификат аннулирован (редкий случай - нарушения, ошибка выдачи). | Виден студенту (с пометкой "Отозван"), администраторам | Только просмотр, сертификат помечен как недействительный |

#### Переходы

| Переход | Инициатор | Условия | Действия при переходе |
|---------|-----------|---------|----------------------|
| [создание] → `issued` | Автоматически | `enrollment.status → completed` | Генерация certificate_number, создание PDF, уведомление студенту |
| `issued → revoked` | Администратор | - | Аннулирование сертификата с указанием причины |

**Детализация переходов:**

**[создание] → issued:**
- **Триггер:** Автоматически при переходе `enrollment.status → completed` (BPMN-процесс проверяет условия сертификации)
- **Видимость:** Сертификат появляется в разделе "Мои сертификаты" у студента. Создается публичная страница по `verification_url` для проверки подлинности
- **Доступ:** Студент может просматривать сертификат и скачивать PDF
- **Дочерние объекты:** Создается запись `certificate_instance`
- **Уведомления:** Студенту отправляется уведомление (type: `certificate_issued`) "Поздравляем! Вам выдан сертификат за прохождение курса [название]. Скачать сертификат: [ссылка]"
- **Обновляемые поля:** При создании:
  - `status = issued`
  - `certificate_number` = автогенерация по паттерну `B3-{YEAR}-{COURSE_CODE}-{SEQUENCE}` (например, `B3-2025-B3-101-00042`)
  - `issue_date = текущая дата`
  - `pdf_file` = генерация PDF через конструктор печатных форм B3 (подстановка данных: студент, курс, оценка, дата в шаблон)
  - `verification_url` = генерация публичной ссылки вида `https://lms.b3.ru/certificates/verify/{certificate_number}`
- **Валидация:** -
- **Обновление родительских объектов:** -

**issued → revoked:**
- **Триггер:** Администратор вручную отзывает сертификат (редкий случай: обнаружено нарушение академической честности, ошибка в выдаче, и т.д.)
- **Видимость:** Сертификат помечается как "Отозван" в интерфейсе студента. На публичной странице `verification_url` отображается статус "Сертификат отозван"
- **Доступ:** Только просмотр, PDF остается доступным для скачивания, но помечен как недействительный
- **Дочерние объекты:** -
- **Уведомления:** Студенту отправляется уведомление (type: `certificate_revoked`) "Ваш сертификат [certificate_number] за курс [название] отозван. Причина: [revocation_reason]". Копия уведомления отправляется администраторам и преподавателю курса
- **Обновляемые поля:** `status = revoked`, `revoked_at = текущее время`, `revoked_by = user_id администратора`, `revocation_reason = [текст причины]`
- **Валидация:** Поле `revocation_reason` обязательно должно быть заполнено
- **Обновление родительских объектов:** -

---

### 5.8. Dialog (Диалог)

#### Статусы

| Статус | Описание | Видимость | Доступ |
|--------|----------|-----------|--------|
| `active` | Активен. Диалог открыт для общения. | Виден участникам (студент + преподаватель курса/задания) | Все участники могут отправлять сообщения |
| `archived` | Архивирован. Диалог закрыт, сохранен для истории. | Виден участникам в архиве | Только просмотр истории сообщений |

#### Переходы

| Переход | Инициатор | Условия | Действия при переходе |
|---------|-----------|---------|----------------------|
| [создание] → `active` | Автоматически | При создании `enrollment` (type=course) ИЛИ при первом сообщении (type=assignment) | Создание контейнера для переписки |
| `active → archived` | Преподаватель / Администратор | Обычно при архивации курса | Диалог закрывается, доступен только для чтения |

**Детализация переходов:**

**[создание] → active:**
- **Триггер:**
  - Для `type=course`: автоматически при создании `enrollment` (каждой записи на курс соответствует диалог для общения с преподавателем по курсу в целом)
  - Для `type=assignment`: при первом сообщении студента или преподавателя по конкретному заданию
- **Видимость:** Диалог появляется в списке сообщений студента и преподавателя
- **Доступ:** Студент и преподаватель могут отправлять сообщения
- **Дочерние объекты:** Создается запись `dialog` с заполненными полями `type`, `reference_id`, `participants` (массив user_id)
- **Уведомления:** -
- **Обновляемые поля:** При создании: `status = active`, `created_at = текущее время`, `participants = [student_user_id, instructor_user_id]`
- **Валидация:** -
- **Обновление родительских объектов:** -

**active → archived:**
- **Триггер:** Преподаватель или администратор вручную архивирует диалог (обычно при завершении или архивации курса)
- **Видимость:** Диалог перемещается в раздел "Архив сообщений"
- **Доступ:** Только просмотр истории сообщений, отправка новых сообщений заблокирована
- **Дочерние объекты:** -
- **Уведомления:** -
- **Обновляемые поля:** `status = archived`
- **Валидация:** -
- **Обновление родительских объектов:** -

---

### 5.9. Диаграммы переходов

#### Жизненный цикл Assignment Instance

```
┌──────────────┐
│ not_started  │ (создан при enrollment)
└──────┬───────┘
       │ студент открыл задание
       ▼
┌──────────────┐
│ in_progress  │
└──────┬───────┘
       │
       ├─────────────────────┐
       │ сдал на проверку    │ автозачёт (лекция)
       ▼                     ▼
┌──────────────┐       ┌──────────────┐
│ under_review │       │  completed   │
└──────┬───────┘       └──────────────┘
       │
       ├─────────────────────┐
       │                     │
       │ оценка выставлена   │ требуется доработка
       ▼                     ▼
┌──────────────┐      ┌──────────────────┐
│  completed   │      │  needs_revision  │
└──────────────┘      └────────┬─────────┘
                               │
                               │ студент исправил
                               ▼
                        ┌──────────────┐
                        │ in_progress  │
                        └──────────────┘
```

#### Жизненный цикл Enrollment

```
┌──────────────┐
│   created    │ (студент отложил курс)
└──────┬───────┘
       │ отправил на согласование
       ▼
┌──────────────────┐
│ pending_approval │
└────────┬─────────┘
         │
         ├──────────────────┐
         │ одобрено         │ отклонено
         ▼                  ▼
┌──────────────┐      ┌──────────────┐
│   approved   │◄─────│   rejected   │◄──┐
└──────┬───────┘      └──────┬───────┘   │
       │                     │           │
       │                     │ студент   │ админ отозвал
       │                     │ редактирует│ согласование
       │                     ▼           │
       │              ┌──────────────┐   │
       │              │   created    │   │
       │              └──────────────┘   │
       │                                 │
       │ start_date ─────────────────────┘
       │ наступила
       ▼
┌──────────────┐
│    active    │
└──────┬───────┘
       │
       ├─────────────┬──────────────┬──────────────┐
       │             │              │              │
       │ все задания │ студент      │ не набрал    │
       │ выполнены   │ отчислился   │ порог баллов │
       │ + балл ≥    │              │              │
       │ threshold   │              │              │
       ▼             ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│  completed   │ │  withdrawn   │ │    failed    │
└──────────────┘ └──────────────┘ └──────────────┘
```

#### Жизненный цикл Course Template

```
┌──────────────┐
│    draft     │ (методист создал)
└──────┬───────┘
       │
       ├──────────────────────────┐
       │ публикация               │ архивация
       ▼                          ▼
┌──────────────┐          ┌──────────────┐
│  published   │─────────►│   archived   │
└──────┬───────┘          └──────────────┘
       │         снятие с
       │         публикации
       ▼
┌──────────────┐
│    draft     │
└──────────────┘
```

### 5.10. Бизнес-правила переходов

1. **Автоматические переходы** (через BPMN-процессы):
   - Course Instance: `planned → active` (по расписанию)
   - Enrollment: `approved → active` (при старте курса)
   - Enrollment: `active → completed/failed` (по условиям завершения)
   - Assignment Instance: `in_progress → under_review` (при сдаче)
   - Assignment Instance: `in_progress → completed` (автозачёт для лекций)

2. **Ручные переходы** (действия пользователей):
   - Assignment Instance: `under_review → completed/needs_revision` (преподаватель)
   - Enrollment: `pending_approval → approved/rejected` (администратор)
   - Enrollment: `rejected → created` (студент редактирует отклоненную заявку)
   - Enrollment: `active → withdrawn` (студент или администратор)
   - Course Template: `draft → published` (методист)

3. **Вычисляемые переходы** (по условиям):
   - Enrollment: `active → completed` (если все обязательные задания `completed` + `total_score >= threshold`)
   - Enrollment: `active → failed` (если `end_date` прошла, но условия не выполнены)

---

## 6. Индексы и производительность

### Рекомендуемые индексы

```sql
-- Course Template
CREATE INDEX idx_course_template_code ON course_template(code);
CREATE INDEX idx_course_template_status ON course_template(status);
CREATE INDEX idx_course_template_accessibility ON course_template(accessibility);

-- Course Instance
CREATE INDEX idx_course_instance_template ON course_instance(course_template_id);
CREATE INDEX idx_course_instance_status ON course_instance(status);
CREATE INDEX idx_course_instance_dates ON course_instance(start_date, end_date);

-- Enrollment
CREATE INDEX idx_enrollment_student ON enrollment(student_id);
CREATE INDEX idx_enrollment_instance ON enrollment(course_instance_id);
CREATE INDEX idx_enrollment_status ON enrollment(status);
CREATE INDEX idx_enrollment_composite ON enrollment(student_id, course_instance_id);

-- Assignment Instance
CREATE INDEX idx_assignment_instance_enrollment ON assignment_instance(enrollment_id);
CREATE INDEX idx_assignment_instance_template ON assignment_instance(assignment_template_id);
CREATE INDEX idx_assignment_instance_status ON assignment_instance(status);

-- Assignment Schedule
CREATE INDEX idx_assignment_schedule_template ON assignment_schedule(assignment_template_id);

-- Launch Schedule
CREATE INDEX idx_launch_schedule_template ON launch_schedule(course_template_id);
CREATE INDEX idx_launch_schedule_active ON launch_schedule(is_active);

-- Message
CREATE INDEX idx_message_dialog ON message(dialog_id);
CREATE INDEX idx_message_author ON message(author_id);
CREATE INDEX idx_message_created ON message(created_at DESC);

-- Notification
CREATE INDEX idx_notification_user ON notification(user_id);
CREATE INDEX idx_notification_read ON notification(is_read);
CREATE INDEX idx_notification_composite ON notification(user_id, is_read, created_at DESC);
```

---

## 7. Вопросы для уточнения / Риски

### 7.1. Вопросы

1. **Поддержка командных заданий**: Нужны ли задания для групп студентов?
2. **Прокторинг тестов**: Требуется ли защита от списывания для тестов?
3. **Интеграция с внешними стендами**: Автоматизация создания VM через API или вручную?
4. **Мультиязычность**: Нужна ли поддержка курсов на нескольких языках?
5. **Аудит изменений**: Требуется ли полная история изменений шаблонов и экземпляров?

### 7.2. Риски

| Риск | Вероятность | Воздействие | Митигация |
|------|-------------|-------------|-----------|
| B3 не поддерживает сложные JSON-поля | Средняя | Высокое | Проверить возможности B3 для хранения JSON, при необходимости разбить на подчиненные таблицы |
| Производительность при 10000+ студентов | Низкая | Среднее | Индексы + денормализация (progress_percentage, total_score) |
| Расширение модели для blended learning | Средняя | Среднее | Поле `delivery_mode` уже добавлено в Assignment Template |
| Конфликты обновления шаблонов | Низкая | Низкое | Версионирование шаблонов (v1, v2) для истории |

---

## 8. Следующие шаги

1. **Валидация с B3 Platform**
   - Проверить поддержку всех типов полей
   - Убедиться в возможности создания foreign keys
   - Проверить ограничения на JSON-поля

2. **Прототипирование в B3**
   - Создать базовые сущности: Course Template, Assignment Template
   - Проверить производительность запросов

3. **BPMN-процессы**
   - Детализировать процесс сдачи заданий
   - Спроектировать процесс выдачи сертификатов
   - Автоматизация уведомлений
   - Процесс автозапуска групп по Launch Schedule

4. **UI/UX**
   - Спроектировать формы ввода для всех сущностей
   - Дашборд студента с прогрессом
   - Дашборд преподавателя (табель)

---

## 9. Изменения в версии 2.0

### Основные изменения от версии 1.0:

1. **Добавлены статусные модели для всех сущностей** с явными enum-полями `status`
2. **Заменено `is_published` на `accessibility`** в Course Template (`public` / `registered`)
3. **Переименовано концептуально** `stream_name` → "Учебная группа" (`group_name`)
4. **Удалены поля** из Course Instance: `max_enrollments`, `settings`
5. **Объединены Enrollment Request и Enrollment** через статус `pending_approval`
6. **Заменены VM-поля на `allocated_resources`** (текстовое поле) в Enrollment
7. **Удалено `due_days`** из Assignment Template и `due_date` из Assignment Instance
8. **Добавлены новые сущности**: Assignment Schedule и Launch Schedule
9. **Обновлена статусная модель** с полными диаграммами переходов и действиями
10. **Проверены все поля из прототипа**: `delivery_mode`, `submission_type` (массив), `category`, `level`

---

## 10. Соответствие прототипу

Все поля из прототипа (proto/data.js) отражены в модели:

**Course Template:**
- ✓ `level` (renamed from `type`)
- ✓ `category`
- ✓ `accessibility` (replaces `is_published`)
- ✓ `status` (new)
- ✓ `target_audience` (replaces `targetAudience`)
- ✓ `requires_lab_environment` (replaces `requiresSandbox`)

**Assignment Template:**
- ✓ `delivery_mode` (`in_person` / `self_study`)
- ✓ `submission_type` (array: `text`, `file`, `url`, `none`)
- ✓ `status` (new)
- ✓ `type` (`lecture` renamed to match, `lab` replaces `practice`)

**Course Instance:**
- ✓ `group_name` (replaces `stream_name`, concept renamed from cohort)
- ✓ `status` (updated)
- ✗ `max_enrollments` (removed per requirements)

**Enrollment:**
- ✓ `status` (expanded with `pending_approval`, `approved`)
- ✓ `allocated_resources` (replaces individual VM fields)
- ✓ `request_comment`, `approval_comment` (new, for merged Enrollment Request)
- ✓ `approved_by`, `approved_at` (new)

**Assignment Instance:**
- ✓ `status` (updated: `not_started`, `in_progress`, `under_review`, `completed`, `needs_revision`)
- ✗ `due_date` (removed, replaced by Assignment Schedule)

**Certificate:**
- ✓ `status` (new for both Template and Instance)

**Schedule (NEW):**
- ✓ Assignment Schedule (defines duration, start condition, offset for each assignment)
- ✓ Launch Schedule (automates course instance creation)

---

**Документ подготовлен:** Main Claude (Orchestrator)
**Статус:** Ready for B3 Implementation

---

## Приложение A: Пример данных

### Шаблон курса

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "code": "B3-101",
  "title": "B3 Platform: Базовый уровень",
  "description": "Введение в платформу B3...",
  "level": "basic",
  "category": "Разработка",
  "duration_hours": 40,
  "certification_threshold": 70.0,
  "requires_lab_environment": true,
  "accessibility": "registered",
  "status": "published"
}
```

### Экземпляр курса

```json
{
  "id": "660e8400-e29b-41d4-a716-446655440001",
  "course_template_id": "550e8400-e29b-41d4-a716-446655440000",
  "group_name": "Группа октябрь 2025",
  "instructor_id": "770e8400-e29b-41d4-a716-446655440002",
  "start_date": "2025-10-01",
  "end_date": "2025-11-30",
  "status": "active"
}
```

### Запись на курс

```json
{
  "id": "880e8400-e29b-41d4-a716-446655440003",
  "student_id": "990e8400-e29b-41d4-a716-446655440004",
  "course_instance_id": "660e8400-e29b-41d4-a716-446655440001",
  "status": "active",
  "enrolled_at": "2025-09-25T10:00:00Z",
  "progress_percentage": 45.5,
  "total_score": 78.3,
  "allocated_resources": "URL: https://lab.b3.local/student-vm-42\nЛогин: student_42\nПароль: TempPass123\nСрок действия: до 30.11.2025"
}
```

### Экземпляр задания

```json
{
  "id": "aa0e8400-e29b-41d4-a716-446655440005",
  "assignment_template_id": "bb0e8400-e29b-41d4-a716-446655440006",
  "enrollment_id": "880e8400-e29b-41d4-a716-446655440003",
  "status": "completed",
  "submission_text": "Выполнил все требования...",
  "submission_files": ["file_id_1", "file_id_2"],
  "submitted_at": "2025-10-15T14:30:00Z",
  "grade": 85.0,
  "feedback": "Отличная работа! Небольшие замечания по оформлению.",
  "graded_at": "2025-10-16T09:00:00Z",
  "graded_by": "770e8400-e29b-41d4-a716-446655440002",
  "attempt_count": 1
}
```

### График заданий

```json
{
  "id": "cc0e8400-e29b-41d4-a716-446655440007",
  "assignment_template_id": "bb0e8400-e29b-41d4-a716-446655440006",
  "duration_days": 7,
  "start_condition": "course_start",
  "start_offset_days": 0
}
```

**Пример вычисления дат:**
При создании учебной группы с `start_date = 2025-10-01`:
- `start_date` задания = 2025-10-01 + 0 дней = 2025-10-01
- `end_date` задания = 2025-10-01 + 7 дней = 2025-10-08

### График запуска

```json
{
  "id": "dd0e8400-e29b-41d4-a716-446655440008",
  "course_template_id": "550e8400-e29b-41d4-a716-446655440000",
  "launch_mode": "periodic",
  "period": "monthly",
  "launch_day": 1,
  "min_students": 5,
  "is_active": true
}
```
