# Модель данных B3 Learning Portal

**Версия:** 1.0
**Дата:** 2025-12-10
**Статус:** Draft

---

## 1. Обзор модели данных

Модель данных B3 Learning Portal построена на принципе **Template → Instance** (Шаблон → Экземпляр), где:
- **Шаблоны** определяют структуру и содержание курсов (создаются методистами)
- **Экземпляры** создаются для каждого потока обучения и каждого слушателя

Это обеспечивает:
- Переиспользование контента (один шаблон → много потоков)
- Изоляцию данных (работа студента не влияет на других)
- Гибкость (каждый поток может настраиваться индивидуально)

### Ключевые принципы

1. **Separation of Concerns**: Четкое разделение на пользователей, контент, процессы обучения
2. **Traceability**: Каждый экземпляр связан со своим шаблоном через внешний ключ
3. **Status-Driven Workflows**: Все сущности имеют явные статусы для управления BPMN-процессами
4. **Audit Trail**: Временные метки и связи для отслеживания всех действий

---

## 2. ER-диаграмма (текстовое описание связей)

```
ПОЛЬЗОВАТЕЛИ:
┌──────────────────┐
│   Пользователь   │ (базовая сущность B3)
└────────┬─────────┘
         │
         ├──────────────────────────────────┐
         │                                  │
         ▼                                  ▼
┌──────────────────┐              ┌──────────────────┐
│ Слушатель курса  │              │ Преподаватель /  │
│                  │              │    Методист      │
└────────┬─────────┘              └──────────────────┘
         │
         │ записан на ▼
         │
         │      ┌─────────────────────┐
         └─────►│  Запись на курс     │◄──┐
                │   (Enrollment)      │   │
                └──────────┬──────────┘   │
                           │              │ ссылается на
                           │              │
                           ▼              │
                  ┌─────────────────────┐ │
                  │ Экземпляр курса     │─┘
                  │ (Course Instance)   │
                  └──────────┬──────────┘
                             │
                             │ основан на ▼
                             │
                    ┌─────────────────────┐
                    │   Шаблон курса      │
                    │ (Course Template)   │
                    └──────────┬──────────┘
                               │
                               │ содержит ▼
                               │
                      ┌─────────────────────┐
                      │  Шаблон задания     │
                      │(Assignment Template)│
                      └──────────┬──────────┘
                                 │
                                 │ порождает ▼
                                 │
                        ┌─────────────────────┐
                        │ Экземпляр задания   │
                        │(Assignment Instance)│◄────┐
                        └──────────┬──────────┘     │
                                   │                │ связь с
                                   │                │
                                   ▼                │
                          ┌─────────────────────┐   │
                          │      Диалог         │───┘
                          │  (по заданию)       │
                          └──────────┬──────────┘
                                     │
                                     │ содержит ▼
                                     │
                            ┌─────────────────────┐
                            │     Сообщение       │
                            │     (Message)       │
                            └─────────────────────┘

СЕРТИФИКАТЫ:
┌──────────────────────┐
│  Шаблон сертификата  │
│(Certificate Template)│
└──────────┬───────────┘
           │
           │ используется для ▼
           │
  ┌─────────────────────────┐
  │ Экземпляр сертификата   │
  │ (Certificate Instance)  │
  └─────────────────────────┘

ЗАЯВКИ:
┌──────────────────────┐
│ Заявка на регистрацию│
│ (Enrollment Request) │
└──────────────────────┘
     │
     │ после одобрения создает ▼
     │
┌──────────────────────┐
│  Запись на курс      │
│   (Enrollment)       │
└──────────────────────┘

УВЕДОМЛЕНИЯ:
┌──────────────────────┐
│    Уведомление       │
│   (Notification)     │
└──────────────────────┘
```

---

## 3. Детальное описание сущностей

### 3.1. Пользователи

#### 3.1.1. Пользователь (User)

**Описание:** Базовая сущность B3 для аутентификации и авторизации. Расширяется для специфичных ролей.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `username` | String(100) | Да | Логин пользователя |
| `email` | Email | Да | Email (уникальный) |
| `full_name` | String(255) | Да | ФИО |
| `phone` | String(20) | Нет | Телефон |
| `is_active` | Boolean | Да | Активен ли аккаунт |
| `created_at` | DateTime | Да | Дата создания |
| `last_login` | DateTime | Нет | Последний вход в систему |

**Связи:**
- Роли: многие-ко-многим (User ↔ Role)

**Примечания:**
- Используется стандартная модель пользователей B3
- Поддерживает SSO/LDAP интеграцию

---

#### 3.1.2. Слушатель курса (Student)

**Описание:** Расширение сущности "Пользователь" с метаданными для учебного процесса.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `user_id` | UUID (FK) | Да | Ссылка на Пользователь |
| `organization` | String(255) | Нет | Организация |
| `department` | String(255) | Нет | Подразделение |
| `position` | String(255) | Нет | Должность |
| `employee_id` | String(50) | Нет | Табельный номер |
| `learning_goals` | Text | Нет | Цели обучения |
| `bio` | Text | Нет | О себе |

**Связи:**
- Один-к-одному: Student → User
- Один-ко-многим: Student → Enrollment (записи на курсы)

---

#### 3.1.3. Преподаватель курса / Методист курса (Instructor/Author)

**Описание:** Роли пользователя для преподавания и создания контента.

**Реализация:**
- Определяется через системные роли B3 (`instructor`, `course_author`)
- Не требует отдельной сущности

**Права доступа:**
- **Методист**: создание/редактирование Шаблонов курсов и заданий
- **Преподаватель**: ведение Экземпляров курсов, проверка заданий, общение со студентами

---

### 3.2. Курсы

#### 3.2.1. Шаблон курса (Course Template)

**Описание:** Определение курса, создаваемое методистом. Является основой для запуска потоков обучения.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `code` | String(50) | Да | Код курса (уникальный, например "B3-101") |
| `title` | String(255) | Да | Название курса |
| `description` | Text | Да | Полное описание |
| `short_description` | Text | Нет | Краткое описание (для карточек) |
| `type` | Enum | Да | Тип: `basic` / `advanced` / `specialized` |
| `category` | String(100) | Нет | Категория (например, "Администрирование", "Разработка") |
| `target_audience` | Text | Нет | Целевая аудитория |
| `prerequisites` | Text | Нет | Требуемые навыки / предварительные курсы |
| `duration_hours` | Integer | Нет | Продолжительность в часах |
| `certification_threshold` | Decimal(5,2) | Да | Минимальный балл для сертификации (0-100) |
| `requires_lab_environment` | Boolean | Да | Требуется ли стенд для практики |
| `cover_image` | File | Нет | Обложка курса |
| `is_published` | Boolean | Да | Опубликован ли (видим в каталоге) |
| `created_by` | UUID (FK) | Да | Автор (методист) |
| `created_at` | DateTime | Да | Дата создания |
| `updated_at` | DateTime | Да | Последнее обновление |

**Связи:**
- Один-ко-многим: Course Template → Assignment Template (задания курса)
- Один-ко-многим: Course Template → Course Instance (экземпляры/потоки)
- Многие-к-одному: Course Template → User (автор)

**Бизнес-правила:**
- `code` должен быть уникальным в системе
- `certification_threshold` используется в BPMN-процессе выдачи сертификата
- Изменение шаблона **не влияет** на уже запущенные экземпляры

---

#### 3.2.2. Экземпляр курса (Course Instance)

**Описание:** Конкретный поток/запуск курса с назначенным преподавателем и датами.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `course_template_id` | UUID (FK) | Да | Ссылка на Шаблон курса |
| `stream_name` | String(100) | Нет | Название потока (например, "Поток октябрь 2025") |
| `instructor_id` | UUID (FK) | Да | Преподаватель |
| `start_date` | Date | Да | Дата начала |
| `end_date` | Date | Да | Дата окончания |
| `status` | Enum | Да | Статус: `planned` / `active` / `completed` / `archived` |
| `max_enrollments` | Integer | Нет | Максимальное количество слушателей |
| `settings` | JSON | Нет | Специфичные настройки потока |
| `created_at` | DateTime | Да | Дата создания |

**Связи:**
- Многие-к-одному: Course Instance → Course Template
- Многие-к-одному: Course Instance → User (преподаватель)
- Один-ко-многим: Course Instance → Enrollment (записи слушателей)

**Статусная модель:**
- `planned` → `active` → `completed` → `archived`

**Бизнес-правила:**
- При создании экземпляра автоматически копируются задания из шаблона
- `max_enrollments` контролируется при записи студентов

---

#### 3.2.3. Заявка на регистрацию (Enrollment Request)

**Описание:** Запрос на запись на курс (для платных/согласуемых курсов). Для бесплатных курсов может создаваться Enrollment напрямую.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `user_id` | UUID (FK) | Да | Пользователь (может быть незарегистрированным) |
| `course_template_id` | UUID (FK) | Да | Желаемый курс |
| `external_email` | Email | Нет | Email внешнего посетителя (если не зарегистрирован) |
| `external_name` | String(255) | Нет | ФИО внешнего посетителя |
| `status` | Enum | Да | `new` / `under_review` / `approved` / `rejected` / `payment_pending` |
| `comment` | Text | Нет | Комментарий от заявителя |
| `rejection_reason` | Text | Нет | Причина отклонения |
| `payment_reference` | String(100) | Нет | Ссылка на оплату (если требуется) |
| `created_at` | DateTime | Да | Дата подачи заявки |
| `processed_at` | DateTime | Нет | Дата обработки |
| `processed_by` | UUID (FK) | Нет | Кто обработал |

**Связи:**
- Многие-к-одному: Enrollment Request → User (опционально)
- Многие-к-одному: Enrollment Request → Course Template

**Статусная модель:**
```
new → under_review → [approved → payment_pending] → enrollment_created
                  └→ rejected
```

**BPMN-процесс:**
1. Создание заявки → статус `new`
2. Администратор/менеджер рассматривает → `under_review`
3. Одобрено → `approved` → если требуется оплата → `payment_pending`
4. После оплаты/одобрения → создается Enrollment

---

#### 3.2.4. Запись на курс (Enrollment)

**Описание:** Связь студента и экземпляра курса. Центральная сущность для отслеживания прогресса.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `student_id` | UUID (FK) | Да | Слушатель |
| `course_instance_id` | UUID (FK) | Да | Экземпляр курса |
| `status` | Enum | Да | `pending` / `active` / `completed` / `withdrawn` / `failed` |
| `enrolled_at` | DateTime | Да | Дата записи |
| `last_activity_at` | DateTime | Нет | Последняя активность |
| `completion_date` | DateTime | Нет | Дата завершения |
| `total_score` | Decimal(5,2) | Нет | Итоговый балл (0-100) |
| `progress_percentage` | Decimal(5,2) | Нет | Процент завершения (0-100) |
| `vm_url` | String(255) | Нет | URL стенда (если выдан) |
| `vm_username` | String(100) | Нет | Логин для стенда |
| `vm_password` | String(100) | Нет | Пароль для стенда (зашифрован) |
| `vm_expires_at` | DateTime | Нет | Срок действия доступа к стенду |

**Связи:**
- Многие-к-одному: Enrollment → Student
- Многие-к-одному: Enrollment → Course Instance
- Один-ко-многим: Enrollment → Assignment Instance (задания студента)
- Один-к-одному: Enrollment → Certificate Instance (если курс завершен)

**Статусная модель:**
```
pending → active → [completed | withdrawn | failed]
```

**Вычисляемые поля:**
- `progress_percentage` = (завершенных заданий) / (всего заданий) × 100
- `total_score` = средний балл по всем обязательным заданиям

**Бизнес-правила:**
- При создании Enrollment автоматически создаются Assignment Instance для всех заданий курса
- Переход в `completed` происходит при выполнении условий сертификации
- Доступ к стенду (`vm_*`) выдается через BPMN-процесс при необходимости

---

### 3.3. Задания

#### 3.3.1. Шаблон задания (Assignment Template)

**Описание:** Определение задания в рамках курса (создается методистом).

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `course_template_id` | UUID (FK) | Да | Курс, к которому относится |
| `module_number` | Integer | Да | Номер модуля |
| `order_number` | Integer | Да | Порядковый номер в курсе |
| `title` | String(255) | Да | Название задания |
| `description` | Text | Да | Описание задания |
| `type` | Enum | Да | `lecture` / `practice` / `quiz` / `project` / `peer_review` |
| `submission_type` | Enum | Нет | `text` / `file` / `url` / `none` (для лекций) |
| `max_score` | Decimal(5,2) | Да | Максимальный балл |
| `due_days` | Integer | Нет | Срок сдачи (дней от начала курса) |
| `is_mandatory` | Boolean | Да | Обязательное для сертификации |
| `materials` | JSON | Нет | Массив ссылок на файлы/URL (лекции, инструкции) |
| `grading_criteria` | Text | Нет | Критерии оценивания |
| `created_at` | DateTime | Да | Дата создания |
| `updated_at` | DateTime | Да | Последнее обновление |

**Связи:**
- Многие-к-одному: Assignment Template → Course Template
- Один-ко-многим: Assignment Template → Assignment Instance

**Типы заданий:**
- `lecture`: Информационный материал (автозасчитывается при просмотре)
- `practice`: Практическое задание (требует проверки преподавателем)
- `quiz`: Тест (может автопроверяться)
- `project`: Проектная работа
- `peer_review`: Взаимная проверка студентами

**Бизнес-правила:**
- `order_number` определяет последовательность заданий
- `due_days` используется для расчета дедлайна относительно `start_date` экземпляра курса
- Изменение шаблона не влияет на уже созданные экземпляры

---

#### 3.3.2. Экземпляр задания (Assignment Instance)

**Описание:** Задание, назначенное конкретному студенту в рамках его записи на курс.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `assignment_template_id` | UUID (FK) | Да | Шаблон задания |
| `enrollment_id` | UUID (FK) | Да | Запись на курс (связь со студентом) |
| `status` | Enum | Да | `not_started` / `in_progress` / `submitted` / `under_review` / `graded` / `needs_revision` |
| `submission_text` | Text | Нет | Текстовое решение |
| `submission_files` | JSON | Нет | Массив загруженных файлов |
| `submission_url` | String(255) | Нет | Ссылка на решение |
| `submitted_at` | DateTime | Нет | Дата сдачи |
| `grade` | Decimal(5,2) | Нет | Оценка (0 до max_score) |
| `feedback` | Text | Нет | Комментарий преподавателя |
| `graded_at` | DateTime | Нет | Дата проверки |
| `graded_by` | UUID (FK) | Нет | Преподаватель, проверивший работу |
| `attempt_count` | Integer | Да | Количество попыток сдачи (default: 0) |
| `due_date` | DateTime | Нет | Дедлайн для этого студента |

**Связи:**
- Многие-к-одному: Assignment Instance → Assignment Template
- Многие-к-одному: Assignment Instance → Enrollment
- Многие-к-одному: Assignment Instance → User (преподаватель, проверивший)
- Один-ко-многим: Assignment Instance → Dialog (диалог по заданию)

**Статусная модель:**
```
not_started → in_progress → submitted → under_review → [graded | needs_revision]
                                                              ↓
                                                        → in_progress (повтор)
```

**BPMN-процесс (сдача задания):**
1. Студент нажимает "Отправить" → `submitted`
2. Преподавателю создается задача на проверку → `under_review`
3. Преподаватель оценивает:
   - Принято → `graded` + оценка + уведомление студенту
   - Доработка → `needs_revision` + комментарий + уведомление

**Бизнес-правила:**
- `due_date` вычисляется при создании: `enrollment.course_instance.start_date + template.due_days`
- При `needs_revision` студент может повторно отправить (increment `attempt_count`)

---

### 3.4. Коммуникации

#### 3.4.1. Диалог (Dialog)

**Описание:** Контейнер для переписки между студентом и преподавателем (по курсу или конкретному заданию).

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `type` | Enum | Да | `course` / `assignment` |
| `reference_id` | UUID | Да | ID Enrollment (для курса) или Assignment Instance (для задания) |
| `participants` | JSON | Нет | Массив user_id участников (студент + преподаватели) |
| `created_at` | DateTime | Да | Дата создания |
| `last_message_at` | DateTime | Нет | Последнее сообщение |

**Связи:**
- Один-ко-многим: Dialog → Message (сообщения в диалоге)
- Полиморфная связь через `reference_id`:
  - Если `type=course` → `reference_id` = Enrollment.id
  - Если `type=assignment` → `reference_id` = Assignment Instance.id

**Бизнес-правила:**
- Диалог создается автоматически при записи на курс (`type=course`)
- Диалог по заданию создается при первой необходимости (отправка вопроса/комментария)

---

#### 3.4.2. Сообщение (Message)

**Описание:** Отдельное сообщение в диалоге.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `dialog_id` | UUID (FK) | Да | Диалог |
| `author_id` | UUID (FK) | Да | Автор сообщения |
| `text` | Text | Да | Текст сообщения |
| `attachments` | JSON | Нет | Массив прикрепленных файлов |
| `is_read` | Boolean | Да | Прочитано ли (default: false) |
| `created_at` | DateTime | Да | Дата создания |

**Связи:**
- Многие-к-одному: Message → Dialog
- Многие-к-одному: Message → User (автор)

**Бизнес-правила:**
- При создании нового сообщения создается Notification для непрочитавших участников
- Автоматическая установка `is_read=true` при открытии диалога

---

### 3.5. Сертификаты

#### 3.5.1. Шаблон сертификата (Certificate Template)

**Описание:** Макет сертификата для печатной формы B3.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `name` | String(255) | Да | Название шаблона |
| `course_type` | Enum | Нет | Для какого типа курса: `basic` / `advanced` / `all` |
| `print_form_id` | UUID (FK) | Да | Ссылка на печатную форму B3 |
| `description` | Text | Нет | Описание |
| `is_active` | Boolean | Да | Активен ли шаблон |
| `created_at` | DateTime | Да | Дата создания |

**Связи:**
- Один-ко-многим: Certificate Template → Certificate Instance
- Один-к-одному: Certificate Template → B3 Print Form

**Бизнес-правила:**
- Шаблон содержит макет с плейсхолдерами: `{student_name}`, `{course_title}`, `{completion_date}`, `{certificate_number}`, `{score}`
- Генерация PDF выполняется конструктором печатных форм B3

---

#### 3.5.2. Экземпляр сертификата (Certificate Instance)

**Описание:** Выданный сертификат конкретному студенту.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `certificate_template_id` | UUID (FK) | Да | Шаблон сертификата |
| `enrollment_id` | UUID (FK) | Да | Запись на курс |
| `student_id` | UUID (FK) | Да | Слушатель (денормализация для быстрого поиска) |
| `certificate_number` | String(50) | Да | Серийный номер (уникальный) |
| `issue_date` | Date | Да | Дата выдачи |
| `pdf_file` | File | Да | PDF-файл сертификата |
| `verification_url` | String(255) | Нет | Публичная ссылка для проверки подлинности |
| `created_at` | DateTime | Да | Дата создания |

**Связи:**
- Многие-к-одному: Certificate Instance → Certificate Template
- Один-к-одному: Certificate Instance → Enrollment
- Многие-к-одному: Certificate Instance → Student

**BPMN-процесс (выдача сертификата):**
1. При завершении курса проверяется условие: `enrollment.total_score >= course_template.certification_threshold`
2. Если да:
   - Создается Certificate Instance
   - Генерируется уникальный `certificate_number`
   - Через конструктор печатных форм B3 создается PDF
   - Сертификат привязывается к профилю студента
   - Отправляется уведомление

**Бизнес-правила:**
- `certificate_number` формируется по паттерну: `B3-{YEAR}-{COURSE_CODE}-{SEQUENCE}` (например, `B3-2025-B3-101-00042`)
- `verification_url` позволяет внешним организациям проверить подлинность

---

### 3.6. Уведомления

#### 3.6.1. Уведомление (Notification)

**Описание:** Уведомление для пользователя о событиях в системе.

**Атрибуты:**

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| `id` | UUID | Да | Уникальный идентификатор |
| `user_id` | UUID (FK) | Да | Получатель |
| `type` | Enum | Да | `assignment_graded` / `new_message` / `deadline_soon` / `certificate_issued` / `enrollment_approved` |
| `title` | String(255) | Да | Заголовок |
| `message` | Text | Да | Текст уведомления |
| `link` | String(255) | Нет | Ссылка на связанный объект |
| `is_read` | Boolean | Да | Прочитано ли (default: false) |
| `created_at` | DateTime | Да | Дата создания |

**Связи:**
- Многие-к-одному: Notification → User

**Типы уведомлений:**
- `assignment_graded`: Задание проверено
- `new_message`: Новое сообщение в диалоге
- `deadline_soon`: Приближается дедлайн задания (за 2 дня)
- `certificate_issued`: Сертификат выдан
- `enrollment_approved`: Заявка на курс одобрена

**Бизнес-правила:**
- Уведомления создаются автоматически BPMN-процессами
- Может быть настроена доставка через email/push (интеграция)
- Автоматическое удаление прочитанных уведомлений старше 90 дней (опционально)

---

## 4. Паттерны Template → Instance

### 4.1. Принцип разделения

**Template (Шаблон):**
- Создается один раз методистом
- Хранит определение структуры
- Может обновляться без влияния на активные экземпляры
- Переиспользуется для множества потоков

**Instance (Экземпляр):**
- Создается для конкретного потока/студента
- Содержит индивидуальные данные (прогресс, оценки)
- Изолирован от других экземпляров
- Ссылается на шаблон через foreign key

### 4.2. Примеры применения

#### Курсы

```
Шаблон курса "B3 Базовый уровень"
    ├─► Экземпляр курса "Поток октябрь 2025" (преподаватель Иванов)
    ├─► Экземпляр курса "Поток декабрь 2025" (преподаватель Петров)
    └─► Экземпляр курса "Корпоративный поток ГосКорп" (преподаватель Сидоров)
```

#### Задания

```
Шаблон задания "Лабораторная работа 1: Создание формы"
    ├─► Экземпляр задания (Студент Петров, Поток октябрь)
    │       status: graded, grade: 85
    ├─► Экземпляр задания (Студент Сидорова, Поток октябрь)
    │       status: submitted, awaiting review
    └─► Экземпляр задания (Студент Иванов, Поток декабрь)
            status: in_progress
```

#### Сертификаты

```
Шаблон сертификата "Базовый уровень"
    ├─► Экземпляр сертификата (Студент Петров, B3-2025-B3-101-00001)
    ├─► Экземпляр сертификата (Студент Иванова, B3-2025-B3-101-00002)
    └─► Экземпляр сертификата (Студент Смирнов, B3-2025-B3-101-00003)
```

### 4.3. Преимущества паттерна

1. **Переиспользование контента**: Один шаблон → множество запусков
2. **Изоляция данных**: Изменения в одном экземпляре не влияют на другие
3. **Версионирование**: Можно обновить шаблон для будущих потоков, не трогая текущие
4. **Аналитика**: Легко сравнивать разные потоки одного курса
5. **Масштабируемость**: Добавление новых потоков не требует копирования контента

---

## 5. Статусная модель

### 5.1. Статусы по сущностям

#### Course Instance

| Статус | Описание | Переходы |
|--------|----------|----------|
| `planned` | Курс запланирован, но еще не начался | → `active` (по дате начала) |
| `active` | Курс идет | → `completed` (по дате окончания) |
| `completed` | Курс завершен | → `archived` (вручную администратором) |
| `archived` | Курс заархивирован | - |

#### Enrollment

| Статус | Описание | Переходы |
|--------|----------|----------|
| `pending` | Ожидает начала курса | → `active` (курс начался) |
| `active` | Студент проходит курс | → `completed` / `withdrawn` / `failed` |
| `completed` | Курс завершен успешно | - |
| `withdrawn` | Студент отчислился | - |
| `failed` | Не выполнил требования | - |

#### Enrollment Request

| Статус | Описание | Переходы |
|--------|----------|----------|
| `new` | Заявка подана | → `under_review` |
| `under_review` | На рассмотрении | → `approved` / `rejected` |
| `approved` | Одобрена | → `payment_pending` (если требуется оплата) |
| `payment_pending` | Ожидает оплаты | → `enrollment_created` |
| `rejected` | Отклонена | - |

#### Assignment Instance

| Статус | Описание | Переходы |
|--------|----------|----------|
| `not_started` | Студент не начал задание | → `in_progress` |
| `in_progress` | Студент работает над заданием | → `submitted` |
| `submitted` | Работа сдана на проверку | → `under_review` |
| `under_review` | Преподаватель проверяет | → `graded` / `needs_revision` |
| `graded` | Оценено | - |
| `needs_revision` | Требуется доработка | → `in_progress` (повтор) |

### 5.2. Диаграммы переходов

#### Жизненный цикл Assignment Instance

```
┌──────────────┐
│ not_started  │ (создан при enrollment)
└──────┬───────┘
       │ студент открыл задание
       ▼
┌──────────────┐
│ in_progress  │
└──────┬───────┘
       │ студент нажал "Сдать"
       ▼
┌──────────────┐
│  submitted   │
└──────┬───────┘
       │ преподаватель взял на проверку
       ▼
┌──────────────┐
│ under_review │
└──────┬───────┘
       │
       ├─────────────────────┐
       │                     │
       │ оценка выставлена   │ требуется доработка
       ▼                     ▼
┌──────────────┐      ┌──────────────────┐
│    graded    │      │  needs_revision  │
└──────────────┘      └────────┬─────────┘
                               │
                               │ студент исправил
                               ▼
                        ┌──────────────┐
                        │ in_progress  │
                        └──────────────┘
```

#### Жизненный цикл Enrollment

```
┌──────────────┐
│   pending    │ (запись создана, курс еще не начался)
└──────┬───────┘
       │ start_date наступила
       ▼
┌──────────────┐
│    active    │
└──────┬───────┘
       │
       ├─────────────┬──────────────┬──────────────┐
       │             │              │              │
       │ все задания │ студент      │ не набрал    │ курс
       │ выполнены   │ отчислился   │ порог баллов │ завершен
       │ + балл ≥    │              │              │ (end_date)
       │ threshold   │              │              │
       ▼             ▼              ▼              ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│  completed   │ │  withdrawn   │ │    failed    │
└──────────────┘ └──────────────┘ └──────────────┘
```

### 5.3. Бизнес-правила переходов

1. **Автоматические переходы** (через BPMN-процессы):
   - Course Instance: `planned → active` (по расписанию)
   - Enrollment: `pending → active` (при старте курса)
   - Assignment Instance: `submitted → under_review` (при сдаче)

2. **Ручные переходы** (действия пользователей):
   - Assignment Instance: `under_review → graded/needs_revision` (преподаватель)
   - Enrollment Request: `under_review → approved/rejected` (администратор)
   - Enrollment: `active → withdrawn` (студент или администратор)

3. **Вычисляемые переходы** (по условиям):
   - Enrollment: `active → completed` (если все обязательные задания `graded` + `total_score >= threshold`)
   - Enrollment: `active → failed` (если `end_date` прошла, но условия не выполнены)

---

## 6. Индексы и производительность

### Рекомендуемые индексы

```sql
-- Course Template
CREATE INDEX idx_course_template_code ON course_template(code);
CREATE INDEX idx_course_template_published ON course_template(is_published);

-- Course Instance
CREATE INDEX idx_course_instance_template ON course_instance(course_template_id);
CREATE INDEX idx_course_instance_status ON course_instance(status);
CREATE INDEX idx_course_instance_dates ON course_instance(start_date, end_date);

-- Enrollment
CREATE INDEX idx_enrollment_student ON enrollment(student_id);
CREATE INDEX idx_enrollment_instance ON enrollment(course_instance_id);
CREATE INDEX idx_enrollment_status ON enrollment(status);
CREATE INDEX idx_enrollment_composite ON enrollment(student_id, course_instance_id);

-- Assignment Instance
CREATE INDEX idx_assignment_instance_enrollment ON assignment_instance(enrollment_id);
CREATE INDEX idx_assignment_instance_template ON assignment_instance(assignment_template_id);
CREATE INDEX idx_assignment_instance_status ON assignment_instance(status);

-- Message
CREATE INDEX idx_message_dialog ON message(dialog_id);
CREATE INDEX idx_message_author ON message(author_id);
CREATE INDEX idx_message_created ON message(created_at DESC);

-- Notification
CREATE INDEX idx_notification_user ON notification(user_id);
CREATE INDEX idx_notification_read ON notification(is_read);
CREATE INDEX idx_notification_composite ON notification(user_id, is_read, created_at DESC);
```

---

## 7. Вопросы для уточнения / Риски

### 7.1. Вопросы

1. **Поддержка командных заданий**: Нужны ли задания для групп студентов?
2. **Прокторинг тестов**: Требуется ли защита от списывания для тестов?
3. **Интеграция с внешними стендами**: Автоматизация создания VM через API или вручную?
4. **Мультиязычность**: Нужна ли поддержка курсов на нескольких языках?
5. **Аудит изменений**: Требуется ли полная история изменений шаблонов и экземпляров?

### 7.2. Риски

| Риск | Вероятность | Воздействие | Митигация |
|------|-------------|-------------|-----------|
| B3 не поддерживает сложные JSON-поля | Средняя | Высокое | Проверить возможности B3 для хранения JSON, при необходимости разбить на подчиненные таблицы |
| Производительность при 10000+ студентов | Низкая | Среднее | Индексы + денормализация (progress_percentage, total_score) |
| Расширение модели для blended learning | Средняя | Среднее | Предусмотреть поле `delivery_mode` в Course Template |
| Конфликты обновления шаблонов | Низкая | Низкое | Версионирование шаблонов (v1, v2) для истории |

---

## 8. Следующие шаги

1. **Валидация с B3 Platform**
   - Проверить поддержку всех типов полей
   - Убедиться в возможности создания foreign keys
   - Проверить ограничения на JSON-поля

2. **Прототипирование в B3**
   - Создать базовые сущности: Course Template, Assignment Template
   - Проверить производительность запросов

3. **BPMN-процессы**
   - Детализировать процесс сдачи заданий
   - Спроектировать процесс выдачи сертификатов
   - Автоматизация уведомлений

4. **UI/UX**
   - Спроектировать формы ввода для всех сущностей
   - Дашборд студента с прогрессом
   - Дашборд преподавателя (табель)

---

**Документ подготовлен:** b3-architect agent
**Статус:** Требует ревью и валидации против B3 Platform

---

## Приложение A: Пример данных

### Шаблон курса

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "code": "B3-101",
  "title": "B3 Platform: Базовый уровень",
  "description": "Введение в платформу B3...",
  "type": "basic",
  "category": "Разработка",
  "duration_hours": 40,
  "certification_threshold": 70.0,
  "requires_lab_environment": true,
  "is_published": true
}
```

### Экземпляр курса

```json
{
  "id": "660e8400-e29b-41d4-a716-446655440001",
  "course_template_id": "550e8400-e29b-41d4-a716-446655440000",
  "stream_name": "Поток октябрь 2025",
  "instructor_id": "770e8400-e29b-41d4-a716-446655440002",
  "start_date": "2025-10-01",
  "end_date": "2025-11-30",
  "status": "active",
  "max_enrollments": 20
}
```

### Запись на курс

```json
{
  "id": "880e8400-e29b-41d4-a716-446655440003",
  "student_id": "990e8400-e29b-41d4-a716-446655440004",
  "course_instance_id": "660e8400-e29b-41d4-a716-446655440001",
  "status": "active",
  "enrolled_at": "2025-09-25T10:00:00Z",
  "progress_percentage": 45.5,
  "total_score": 78.3,
  "vm_url": "https://lab.b3.local/student-vm-42",
  "vm_username": "student_42",
  "vm_expires_at": "2025-11-30T23:59:59Z"
}
```

### Экземпляр задания

```json
{
  "id": "aa0e8400-e29b-41d4-a716-446655440005",
  "assignment_template_id": "bb0e8400-e29b-41d4-a716-446655440006",
  "enrollment_id": "880e8400-e29b-41d4-a716-446655440003",
  "status": "graded",
  "submission_text": "Выполнил все требования...",
  "submission_files": ["file_id_1", "file_id_2"],
  "submitted_at": "2025-10-15T14:30:00Z",
  "grade": 85.0,
  "feedback": "Отличная работа! Небольшие замечания по оформлению.",
  "graded_at": "2025-10-16T09:00:00Z",
  "graded_by": "770e8400-e29b-41d4-a716-446655440002",
  "attempt_count": 1
}
```
